var jsonpCallBack,routeCounter=0;!function(a){var b,c=a.localStorage,d=/(special|booker(?:Edit|Add|Choose)|address(?:Add|Edit)|coupon)/;b=angular.module("orderApp",["ngRoute","ngTouch","orderControllers","orderServices","orderDirectives","orderFilters"]),b.run(["$rootScope","$location","cm",function(a,b,e){a.$on("$routeChangeStart",function(a,d,e){-1==location.href.indexOf("wapFlag=1")&&(c.removeItem("datePickerData"),c.removeItem("ticket_skill_DATA"),c.removeItem("special_booker_choose"),c.removeItem("specialBooker_fill"),c.removeItem("special_booker"),c.removeItem("specialTraveller_fill"),c.removeItem("special_traveller"),c.removeItem("special_traveller_choose"),c.removeItem("H5specialTicket_invoiceApply"),c.removeItem("special_visitDate"),c.removeItem("special_insures"),c.removeItem("special_insureSelected"),b.search().wapFlag=1)}),a.$on("$routeChangeSuccess",function(a,c,f){d.test(b.$$path),e.runStatis(RegExp.$1),++routeCounter}),a.$on("$routeChangeError",function(a,b,c){})}]),a.orderControllers=angular.module("orderControllers",["lucky.ui"]),a.orderServices=angular.module("orderServices",[]),a.orderDirectives=angular.module("orderDirectives",[]),a.orderFilters=angular.module("orderFilters",[]),b.config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){var d;d="./templates/view",a.when("/special",{templateUrl:d+"/spacialOrderInput.html",controller:"ticketOrderInputCtrl"}).when("/bookerChoose",{templateUrl:d+"/bookerChoose.html",controller:"bookerChooseCtrl"}).when("/bookerAdd",{templateUrl:d+"/bookerAdd.html",controller:"bookerAddCtrl"}).when("/bookerEdit",{templateUrl:d+"/bookerEdit.html",controller:"bookerEditCtrl"}).when("/addressChoose",{templateUrl:d+"/addressChoose.html",controller:"addressChooseCtrl"}).when("/addressAdd",{templateUrl:d+"/addressAdd.html",controller:"addressAddCtrl"}).when("/addressEdit",{templateUrl:d+"/addressEdit.html",controller:"addressEditCtrl"}).when("/specialOrderInput",{templateUrl:d+"/spacialOrderInput.html",controller:"ticketOrderInputCtrl"}).when("/datePicker",{templateUrl:d+"/datePicker-transfer.html",controller:"datePickCtrl"}).when("/coupon",{templateUrl:d+"/coupon.html",controller:"couponCtrl"}).when("/insure",{templateUrl:d+"/insure.html",controller:"insure"}).otherwise({redirectTo:"/special"}),c.interceptors.push("myInterceptor")}]).factory("myInterceptor",["$log","$rootScope","$timeout",function(a,b,c){return{request:function(a){return a},requestError:function(a){return a},response:function(a){function d(a,b,d,e){return b[d]=a,b[e]=!0,c(function(){b[e]=!1},2e3),!1}if(-1!=a.config.url.indexOf("api.com.user.getUser"))return a;var e=a.data;try{e.code&&-1==e.code&&d(e.errorMessage,b,"errorMsg","showErrMsg")}catch(f){}return a},responseError:function(a){return a}}}])}(window),orderServices.factory("cm",["$http","$q","$location","$timeout",function(a,b,c,e){function f(){var a=navigator.userAgent;return a.indexOf("Windows Phone")>0&&a.indexOf("WebView")>0}var g=navigator.userAgent,h=function(a){var b=document.querySelectorAll.bind(document),c=b(a);return angular.element(c)},i=[],j=function(a,b){var a=a||"加载中...",c='<div class="dataLoading"><i></i><i></i><span>'+a+'</span></div><div class="loadingMask"></div>',d={template:c,url:b};if(i.push(d),0===h(".dataLoading").length){h("body").append(c);var e=function(a){a.preventDefault()};document.querySelector(".loadingMask").addEventListener("touchmove",e,!1),document.querySelector(".dataLoading").addEventListener("touchmove",e,!1)}},k=function(a){var b=-1;for(var c in i)if(i[c].url==a){b=c;break}-1!=b&&(i.splice(b),h(".dataLoading, .loadingMask").remove(),i.length&&h("body").append(i[0].template))},l=function(b,c){var d,e,f,g,h,i;f=b||{},h=f.url||"",e=f.method||"GET",g=f.params||{},d=f.data||{},i=f.loadingText;var l=navigator.userAgent;return l.indexOf("LVMM")>-1&&l.indexOf("iPhone; CPU")>-1?(g.firstChannel="IPHONE",g.secondChannel="AppStore"):l.indexOf("LVMM")>-1&&l.indexOf("Android")>-1?(g.firstChannel="ANDROID",g.secondChannel=l.substring(l.indexOf("ANDROID_")+8,l.lastIndexOf("LVMM")-1)):l.indexOf("LVMM")>-1&&l.indexOf("iPad; CPU OS")>-1?(g.firstChannel="IPAD",g.secondChannel="AppStore"):l.indexOf("Windows Phone")>-1&&l.indexOf("WebView")>-1?(g.firstChannel="WP",g.secondChannel="WPStore"):(g.firstChannel="TOUCH",g.secondChannel="LVMM"),j(i,h),a({method:e,url:h,params:g,data:d}).success(function(a){c.resolve(a),i&&k(h)}).error(function(a){c.reject(a),i&&k(h)})},m=c.search(),n={lvsessionid:"",osVersion:"",lvversion:"",globalLongitude:"",globalLatitude:"",branchType:"",goodsIds:"",productId:"",saleId:"",saleChannel:""};for(var o in m)""!=m[o]&&(n[o]=m[o]),void 0==m[o]&&(n[o]=null);return{isWPApp:f,commonParams:n,$:h,getUrlParam:function(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)"),c=location.hash.substr(1).match(b);return null!=c?unescape(c[2]):null},trim:function(a){return a.replace(/(^\s*)|(\s*$)/g,"")},delCookie:function(a){d.cookie=a+"=;expires="+new Date(0).toGMTString()},setCookie:function(a,b){var c=new Date;c.setTime(c.getTime()+2592e6),document.cookie=a+"="+escape(b)+";expires="+c.toGMTString()},getCookie:function(a){for(var b=document.cookie.split(";"),c=0;c<b.length;c++){var d=b[c].split("=");if(this.trim(d[0])==a)return decodeURIComponent(d[1])}},post:function(a){var c;return c=b.defer(),a.method="POST",l(a,c),c.promise},get:function(a){var c;return c=b.defer(),a.method="GET",l(a,c),c.promise},getJSON:function(a){var c,d=a.url.indexOf("?")>-1?"&callback=JSON_CALLBACK":"?callback=JSON_CALLBACK";return a.url+=d,c=b.defer(),a.method="jsonp",l(a,c),c.promise},getUrls:function(){return{getMsgCode:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.common.ticket.order.getMsgAuthCode&version=1.0.0&lvversion=7.10.3",isNeedMsgAuthCode:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.msg.isNeedMsgAuthCode&version=1.0.0&lvversion=7.10.3",checkImgCode:"//m.lvmama.com/usso/router/rest.do?method=api.com.anonymous.order.checkImageAuthCode&version=3.0.0&lvversion=7.10.3",inputTicketOrder:"//m.lvmama.com/other/router/rest.do?method=api.com.groupbuy.ticket.order.inputTicketOrderAvoidTheLogin&version=1.0.0&lvversion=8.0.6",getInputOptions:"//m.lvmama.com/nticket/router/rest.do?method=api.com.csa.ticket.order.getInputOptions&version=1.0.0&formate=json",getGoodsTimePrice:"//m.lvmama.com/other/router/rest.do?method=api.com.groupbuy.ticket.goods.getGoodsTimePrice&version=1.0.0&formate=json&firstChannel=TOUCH&secondChannel=LVMM",countTicketPrice:"//m.lvmama.com/other/router/rest.do?method=api.com.groupbuy.ticket.order.countTicketPrice&version=1.0.0&formate=json",checkTicketOrder:"//m.lvmama.com/nticket/router/rest.do?method=api.com.csa.ticket.getTravellerInputInfo&formate=json&branchType=BRANCH&version=1.0.0",createOrder:"//m.lvmama.com/other/router/rest.do?method=api.com.groupbuy.ticket.order.createOrderAvoidTheLogin&version=1.0.0&lvversion=8.0.6",getUser:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.getUser&version=1.0.0",addContact:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.addContact&version=1.0.0",removeContact:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.removeContact&version=1.0.0",updateContact:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.updateContact&version=1.0.0",getContact:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.getContact&version=1.0.0&receiversType=Contact",addAddress:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.addAddress&version=1.0.0",removeAddress:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.deleteAddress&version=1.0.0&receiversType=Address",updateAddress:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.updateAddress&version=1.0.0",getAddress:"//m.lvmama.com/api/router/rest.do?method=api.com.user.getAddress&version=1.0.0",getCity:"//m.lvmama.com/api/router/rest.do?method=api.com.ticket.goods.getDistricts&version=1.0.0&formate=json",getCoupon:"//m.lvmama.com/usso/router/rest.do?method=api.com.user.getCoupon&state=NOT_USED&osVersion=4.1.1&version=1.0.0&formate=json",postlosc:"//m.lvmama.com/api/router/rest.do?method=api.com.trip.other.postlosc&version=1.0.0",getInsurance:"//m.lvmama.com/other/router/rest.do?method=api.com.groupbuy.ticket.goods.getGoodsInsuranceInfo&version=1.0.0"}},priceFilter:function(a){var b=a.replace(/\(|\)/g,"");return b.indexOf(",")<0&&(b+=","),b},runStatis:function(a){var b,c="H5_",d="_特卖会";!!(b={bookerEdit:["游玩人编辑页","Tourist"],bookerAdd:["游玩人新增页","Tourist"],bookerChoose:["游玩人选择页","Tourist"],addressAdd:["常用地址新增页","Tourist"],addressChoose:["常用地址编辑页","Tourist"],contract:["合同","Contract"],coupon:["优惠券","AroundBounce"]}[a])&&this.statistics(c+b[0]+d,b[1])},isNotEmpty:function(a){return null!=a&&"undefined"!=a&&void 0!=a&&0!=a.length},statistics:function(a,b){var c=setInterval(function(){if(_LVMAMA_COREMETRICS){_LVMAMA_COREMETRICS.init(document.domain);var d="",e="",f="",h="App";f=g.indexOf("Mobile")>0&&g.indexOf("iPhone OS")>0&&g.indexOf("LVMM")>0?"IP-":g.indexOf("Mobile")>0&&g.indexOf("Android")>0&&g.indexOf("LVMM")>0?"AD_":"WAP_","WAP_"==f&&(h="WAP_"),d=h+a,e=f+b,cmCreatePageviewTag(d,e,null,null),clearInterval(c)}},200)},showErr:function(a,b,c,d,f){return b[c]=a,b[d]=!0,e(function(){b[d]=!1,f&&f.obj.focus()},2e3),!1},validate:function(a,b,c,d){function e(a,b){return a.getAttribute(b)}function f(a){return"[object Array]"==={}.toString.call(a)}var g,i,j,k,l,m,n,o,p={email:/^(?:\w+\.?)*\w+@(?:\w+\.)+\w+$/,ID:/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,mobile:/^\d{11}$/,upper:/^[A-Z]+$/,chinese:/^([\u4E00-\u9FA5]+,?)+$/,postcode:/^[0-9]{6}$/},q={email:"邮箱",ID:"身份证",mobile:"手机号",upper:"大写字母",chinese:"中文",postcode:"邮编"};if(d&&f(d))for(k=0,len=d.length;k<len;)if(i=d[k++],!i.check)return this.showErr(i.err,a,b,c);for(g=[].slice.call(h("input[data-valid=true]")),k=0,len=g.length;k<len;){if(i=g[k++],j=i.value,l=e(i,"data-require"),n=e(i,"data-type"),m=e(i,"data-require-err")||"请输入"+q[n]+"内容",o=e(i,"data-type-err")||q[n]+"格式错误",l&&!j)return this.showErr(m,a,b,c,{obj:i});if(n&&j.length&&p[n]&&!p[n].test(j))return this.showErr(o,a,b,c,{obj:i})}return!0}}}]),orderServices.factory("dataManager",function(){var a={};return{setData:function(b,c){b&&angular.isString(b)&&(a[b]=c)},getData:function(b){if(b&&angular.isString(b))return a[b]}}}),function(a,b){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("Requires window with document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){function c(a,b){return"number"!=typeof b||m[d(a)]?b:b+"px"}function d(a){return a.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/_/g,"-").toLowerCase()}function e(a){if(!(this instanceof g))return new g(arguments[0]);this.init(a),this.context=j}var f,g,h=Array.prototype,i=Object.prototype,j=a.document,k=!!j.documentElement.classList,l=void 0===window.$,m={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1},n={},o={doc:j,slice:h.slice,toString:i.toString,hasOwn:i.hasOwnProperty,indexOf:h.indexOf,classFlg:k,genUUID:function(a){return a=a||"LVMM",(a+Math.random()+Math.random()).replace(/0\./g,"")},qsa:function(a,b){return b=b||o.doc,o.isString(a)?/[#|\.]*[\w|\d]+\s+[#|\.]\S+/.test(a)?b.querySelectorAll(a):/#\S+/.test(a)?o.doc.getElementById(a.substring(1)):/\.\S+/.test(a)?b.getElementsByClassName(a.substring(1)):b.getElementsByTagName(a):a},isFunction:function(a){return"[object Function]"===o.toString.call(a)},isUndefined:function(a){return void 0===a},isNaN:function(a){return o.isNumber(a)&&a!==+a},isEmpty:function(a){return o.isUndefined(a)||o.isNull(a)||!1===a||0===a||""===a||o.isNaN(a)},canExtend:function(a){return o.isArray(a)||o.isObject(a)},reset:function(a){return null},each:function(a,b,c){var d,e=0,f=a.length;if(o.isUndefined(f)||o.isFunction(a)){for(d in a)if(b(a[d],d,a,c||null))return!1}else for(;e<f;e+=1)if(b(a[e],e,a,c||null))return!1;return a},extend:function(a,b,c){return 2 in arguments||!o.isObject(a)||o.isObject(b)||(a=[c=b,b=a,this][2]),o.each(b,function(b,d,e){o.isArray(b)&&!o.isArray(a[d])&&(a[d]=[]),o.isObject(b)&&!o.isObject(a[d])&&(a[d]={}),o.canExtend(b)?o.extend(a[d],b,c):(c||o.isEmpty(a[d]))&&(a[d]=b)}),a},contains:function(a,b){if(o.isString(a)&&(a=a.split(/\s+/)),o.indexOf)return o.indexOf.call(a,b)>-1;for(var c in a)if(a[c]===b)return!0;return!1}};o.each("Array Object Null Number String".split(/\s/),function(a,b){o["is"+a]=function(b){return o.toString.call(b)==="[object "+a+"]"}}),f={init:function(a){var b=this,c=0;if(!a)return g;if(!o.isString(a)&&1==a.nodeType)return b[0]=a,b.length=1,b;var d=o.qsa(a);return 1==d.nodeType?(b[0]=d,b.length=1):(o.each(d,function(a,d){b[d]=a,c+=1}),b.length=c),b},find:function(a){return a?1==this.length?g(o.qsa(a,this[0])):o.each(this,function(b){var c=0;o.each(o.qsa(a,b),function(a){this[c++]=a}),this.length=c}):g},each:function(a,b){for(var c=0,d=this.length;c<d;c+=1)if(a(this[c],c,b))return!1;return this},data:function(a,b){if(!(1 in arguments)){var c=this[0].getAttribute("data-"+a);return o.isNaN(+c)?c:c>>0}return this.each(function(c){c.setAttribute("data-"+a,b)}),this},css:function(b,d){var e;this.length;return 1 in arguments?(this.each(function(a,c){a.style[b]=d}),this):o.isObject(b)?(this.each(function(a,d){e=[],o.each(b,function(a,b){e.push(b+":"+c(b,a))}),a.style.cssText+=e.join(";")})&&o.reset(e),this):a.getComputedStyle(this[0],null).getPropertyValue(b)||this[0].currentStyle[b]},on:function(a,b,c){return c=c||!1,o.isString(a)&&(a=a.split(/\s+/)),o.isArray(a)&&this.each(function(d,e){var f=o.genUUID();n[f]=[],o.each(a,function(a){d.lvmmID=f,d.addEventListener(a,function(a){a.originalEvent=a,b(a)},c),n[f].push({evt:a,fn:b,cap:c})})}),this},off:function(a,b,c){return 0 in arguments?(o.isString(a)&&(a=a.split(/\s+/)),o.isArray(a)&&this.each(function(d,e){o.each(a,function(a){d.removeEventListener(a,b,c||!1)})})):this.each(function(a,b){!o.isUndefined(a.lvmmID)&&o.each(n[a.lvmmID],function(b,c){a.removeEventListener(b.evt,b.fn,b.cap)})}),this},hasClass:k?function(a){return!!o.isString(a)&&!!this.each(function(b,c){return!o.each(a.split(/\s+/),function(a){if(!b.classList.contains(a))return!0})})}:function(a){var b;return!!o.isString(a)&&!!this.each(function(c,d){return b=c.className.split(/\s+/),!o.each(a.split(/\s+/),function(a){if(-1==b.indexOf(a))return!0})})},addClass:k?function(a){return o.isString(a)&&this.each(function(b,c){o.each(a.split(/\s+/),function(a){b.classList.add(a)})}),this}:function(a){var b;return o.isString(a)&&this.each(function(c,d){b=c.className.split(/\s+/),o.each(a.split(/\s+/),function(a){!o.contains(b,a)&&b.push(a)}),c.className=b.join(" ")}),this},removeClass:k?function(a){return o.isString(a)&&this.each(function(b,c){o.each(a.split(/\s+/),function(a){b.classList.remove(a)})}),this}:function(a){var b;return o.isString(a)&&this.each(function(c,d){b=[],o.each(c.className.split(/\s+/),function(c,d){!o.contains(a,c)&&b.push(c)}),c.className=b.join(" ")}),this},removeAttr:function(a){return this.each(function(b,c){b.removeAttribute(a)}),this},attr:function(a,b){if(1 in arguments)this.each(function(c,d){c.setAttribute(a,b)});else if(o.isString(a))return this[0].getAttribute(a);return this},eq:function(a){return g(this[a||0])}},e.fn=e.prototype=f,o.extend(e,o,!0),!b&&l&&(window.$=window.LvQuery=g=e)}),function(a){a.fn.stop=function(){},a.each(["height","width"],function(b){a.fn[b]=function(){return this.css(b).replace(/px/,"")>>0}}),a.each("click focus blur".split(/\s+/),function(b){a.fn[b]=function(a){return this.on(b,a,!1)}}),a.extend(a,{dateFormat:function(b){var c={date:"",sum:0};a.extend(c,b),"string"==typeof c.date&&(c.date=c.date.split("-"));var d=new Date;return d.setDate(c.date[2]),d.setMonth(c.date[1]-1),d.setFullYear(c.date[0]),d=new Date(d.getTime()+864e5*c.sum),[d.getFullYear(),d.getMonth()+1,d.getDate()]}}),a.extend({imgToBase64:function(b,c,d){var e=document.createElement("CANVAS"),f=e.getContext("2d"),g=new Image;g.crossOrigin="Anonymous",e.height=c?c.height:100,e.width=c?c.width:100,f.drawImage(g,0,0);var h=e.toDataURL(outputFormat||"image/png");return a.reset(e),h}})}(LvQuery);var LuckyUI=angular.module("lucky.ui",[]);LuckyUI.service("overlay",["$rootScope",function(a){var b=this;this.layer=0;var c=[];this.show=function(b){this.layer++,c.push(b),a.$broadcast("overlay-add")},this.hide=function(){b.layer--,c.pop(),a.$broadcast("overlay-remove")},this.clear=function(){this.layer=0,c=[],a.$broadcast("overlay-remove")},this._doClick=function(){var a=c.pop();"function"==typeof a&&(c.push(a),a())}}]).directive("overlay",["overlay","$timeout",function(a){return{replace:!0,scope:!0,template:'<div id="overlay"  ng-click="bindClick();"></div>',restrict:"EA",link:function(b,c){b.$on("overlay-add",function(){a.layer>0&&(c.css("display","block"),setTimeout(function(){c.addClass("show")},10)),b.bindClick=function(){a._doClick()}}),b.$on("overlay-remove",function(){b.click=a._doClick,0==a.layer&&(c.removeClass("show"),setTimeout(function(){c.css("display","none")},100))}),c.on("touchmove",function(a){a.preventDefault()})}}}]),LuckyUI.service("singleSelectorPopup",["$rootScope","$q","overlay","$timeout",function(a,b,c,d){function e(){c.hide(),g.shown=0,a.$broadcast("single-hide")}var f,g=this;this.shown=0,this.opts=null,this.show=function(d){return f=b.defer(),c.show(g.hide),g.shown=1,g.opts=$.extend({title:"单栏选择器",initData:null,data:[]},d),a.$broadcast("single-show"),f.promise},this.hide=function(){g.onCancel()},this.onConfirm=function(a){f&&g.shown&&(e(),d(function(){f.resolve(a)}))},this.onCancel=function(a){f&&g.shown&&(e(),d(function(){f.reject(a)}))}}]).directive("singleSelectorPopup",["singleSelectorPopup","$timeout",function(a,b){return{replace:!0,scope:!0,template:'<div id="single-selector" class="popup" ng-show="show"><header class="popup-header"><button class="blue fr" ng-click="_onConfirm();">完成</button><button class="fl" ng-click="_onCancel();">取消</button><div class="con">{{opts.title}}</div></header><div class="single selector-body single_selector_body"><div class="reticle"></div><ul class="level-1"><li ng-repeat="item in opts.data" ng-class="{\'active\':$index==0}" data-id="{{item.id}}" data-index="$index">{{item.name}}</li></ul></div></div>',restrict:"EA",controller:["$scope","$element",function(c,d){function e(a,b,c){var d=-(a.height()-40);!c&&d>b&&(b=(b+d)/2),!c&&b>0&&(b/=2),a.data("offset",b).css({"-webkit-transform":"translateY("+b+"px)",transform:"translateY("+b+"px)"})}function f(a){return a.data("offset")}function g(a){a.css({"-webkit-transition":"all ease 0.2s",transition:"all ease 0.2s"})}function h(a){a.css({"-webkit-transition":"none",transition:"none"})}function i(a){var b=a.now-a.start;p.find("li").removeClass("active"),e(p,p.data("startOffset")+b)}function j(){p.stop(),p.data("start",!0),p.data("startOffset",f(p))}function k(a,c,d){c=Math.round(c/40),d||g(a),e(a,40*c),d||b(function(){h(a),a.find("li").removeClass("active").eq(-c).addClass("active")},200),d&&a.find("li").removeClass("active").eq(-c).addClass("active")}function l(a){p.data("start",!1);var b=-(p.height()-40),c=a.now-a.start,d=+new Date-a.startTime,e=(d+100)/d,f=p.data("startOffset")+c*e;f>0?k(p,0):b>f?k(p,b):k(p,f)}function m(){var a=c.opts.data[0]?c.opts.data[0].id:null,b=c.opts.initData||a,f=p.find("li[data-id="+b+"]");d.length||(f=p.find("li").eq(0),b=a);var g=f.index();"number"==typeof g&&(p.find(".active").removeClass("active"),f.addClass("active"),e(p,40*-g,!0))}var n=d,o=n.find(".single_selector_body"),p=n.find(".level-1").data("offset",0),q=null;c.show=0,c.opts={},c.$on("single-show",function(){c.show=a.shown,c.onConfirm=a.onConfirm,c.onCancel=a.onCancel,c.opts=a.opts,n.removeClass("show"),n.removeAttr("style"),b(function(){m()},50),b(function(){n.addClass("show")},100)}),c.$on("single-hide",function(){n.removeClass("show"),b(function(){c.show=0},100)}),c._onConfirm=function(){var b=p.find(".active").data("id");a.onConfirm(b)},c._onCancel=function(){a.onCancel()},n.on("touchmove",function(a){a.preventDefault()}),o.on("touchstart mousedown",function(a){var b=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;q={start:b.clientY,startTime:+new Date,now:b.clientY},j(q)}).on("touchend mouseup",function(){l(q),q=null}).on("touchmove mousemove",function(a){var b=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;q&&(q.now=b.clientY,i(q))})}]}}]),LuckyUI.service("doubleSelectorPopup",["$rootScope","$q","overlay","$timeout",function(a,b,c,d){function e(){c.hide(),g.shown=0,a.$broadcast("double-hide")}var f,g=this;this.shown=0,this.opts=null,this.show=function(d){return f=b.defer(),c.show(g.hide),g.shown=1,g.shown=1,g.opts=$.extend({title:"双栏选择器",initData:null,getRightListData:function(){},data:[]},d),a.$broadcast("double-show"),f.promise},this.hide=function(){g.onCancel()},this.onConfirm=function(a){f&&g.shown&&(e(),d(function(){f.resolve(a)}))},this.onCancel=function(a){f&&g.shown&&(e(),d(function(){f.reject(a)}))}}]).directive("doubleSelectorPopup",["doubleSelectorPopup","$timeout",function(a,c){return{replace:!0,scope:!0,template:'<div id="double-selector" class="popup" ng-show="show"><header class="popup-header"><button class="blue fr" ng-click="_onConfirm();">完成</button><button class="fl" ng-click="_onCancel();">取消</button><div class="con">{{opts.title}}</div></header><div class="double selector-body double_selector_body"><div class="reticle"></div><ul class="level-1"><li ng-repeat="item in opts.data" ng-class="{\'active\':$index==0}" data-id="{{item.id}}">{{item.name}}</li></ul><ul class="level-2"><li ng-repeat="item in currentLevel" ng-class="{\'active\':$index==0}" data-id="{{item.id}}">{{item.name}}</li></ul></div></div>',restrict:"EA",controller:["$scope","$element",function(d,e){function f(a,b,c){var d=-(a.height()-40);return!c&&d>b&&(b=(b+d)/2),!c&&b>0&&(b/=2),a.data("offset",b).css({"-webkit-transform":"translateY("+b+"px)","-transform":"translateY("+b+"px)"}),!0}function g(a){return a.data("offset")}function h(a){a.css({"-webkit-transition":"all ease 0.2s",transition:"all ease 0.2s"})}function i(a){a.css({"-webkit-transition":"none",transition:"none"})}function j(a){var b=a.now-a.start,c=1==a.side?s:t;c.find("li").removeClass("active"),f(c,c.data("startOffset")+b)}function k(a){var b=1==a.side?s:t;b.stop(),b.data("start",!0),b.data("startOffset",g(b))}function l(a,b,d){b=Math.round(b/40),d||h(a),f(a,40*b),d||c(function(){i(a);var c=a.find("li").removeClass("active").eq(-b).addClass("active").data("id");a.hasClass("level-1")&&m(-b,c)},200),d&&a.find("li").removeClass("active").eq(-b).addClass("active")}function m(a,b){d.currentLevel=n(a,b),l(t,0,!0)}function n(a,b){var c=d.opts.getRightListData(b);return c||(d.opts.data&&d.opts.data[a]?d.opts.data[a].data:null)}function o(a){var b=1==a.side?s:t;b.data("start",!1);var c=-(b.height()-40),d=a.now-a.start,e=+new Date-a.startTime,f=(e+100)/e,g=b.data("startOffset")+d*f;g>0?l(b,0):c>g?l(b,c):l(b,g)}function p(){var a=[d.opts.data[0].id,n(0,d.opts.data[0].id).id],e=d.opts.initData||a,g=s.find("li[data-id="+e[0]+"]");g.length||(g=s.find("li").eq(0),e=a);var h=g.index();if("number"==typeof h&&h>=0){s.find(".active").removeClass("active");var i=g.addClass("active").data("id");f(s,40*-h,!0),m(h,i),f(t,0,!0),c(function(){var a=t.find("li[data-id="+e[1]+"]"),c=a.index();"number"==typeof b&&b>=0&&(t.find(".active").removeClass("active"),a.addClass("active"),f(t,40*-c,!0))},100)}}var q=e,r=q.find(".double_selector_body"),s=r.find(".level-1").data("offset",0),t=r.find(".level-2").data("offset",0),u=null;d.show=0,d.opts={},d.$on("double-show",function(){d.show=a.shown,d.onConfirm=a.onConfirm,d.onCancel=a.onCancel,d.opts=a.opts,d.currentLevel=d.opts.data?d.opts.data[0].data:null,q.removeClass("show"),q.removeAttr("style"),c(function(){p()},50),c(function(){q.addClass("show")},100)}),d.$on("double-hide",function(){q.removeClass("show"),c(function(){d.show=0},100)}),d._onConfirm=function(){var b=[s.find(".active").data("id"),t.find(".active").data("id")];a.onConfirm(b)},d._onCancel=function(){a.onCancel()},q.on("touchmove",function(a){a.preventDefault()}),r.on("touchstart mousedown",function(a){var b,c=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;b=c.clientX<q.width()/2?1:2,u={start:c.clientY,startTime:+new Date,side:b,now:c.clientY},k(u)}).on("touchend mouseup",function(){o(u),u=null}).on("touchmove mousemove",function(a){var b=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;u&&(u.now=b.clientY,j(u))})}]}}]),LuckyUI.directive("selector",["$timeout","singleSelectorPopup",function(a,b){return{replace:!0,scope:{value:"=",options:"=",name:"@",readonly:"@",index:"="},template:"<span class='selector' ng-click='showPopup();'>{{str}}</span>",restrict:"EA",controller:["$scope","$element",function(a){function c(b){var c=d;return a.options&&a.options.length&&$.each(a.options,function(d,e){e.id==b&&(c=e.name,a.index=d)}),c}var d="请选择";a.readonly&&(d=""),a.value=a.value||0,a.str=c(a.value),a.$watch(function(){return JSON.stringify([a.value,a.hide])},function(){a.str=c(a.value)}),a.readonly||(a.showPopup=function(){b.show({title:a.name,initData:a.value,data:a.options}).then(function(b){a.value=b})})}]}}]);var myCity;LuckyUI.directive("myLocationSelector",["tripleSelectorPopup",function(a){return{replace:!0,scope:{name:"@",error:"=",require:"@",readonly:"@"},template:'<span class="luckyselector location" ng-click="click();">{{str}}</span>',restrict:"E",controller:["$rootScope","$scope","$element","cm",function(b,c,d,e){function f(a,b,c){return h.getLocationName(a,b,c)}function g(){var a=c.name,b={status:!1,desc:""};return parseInt(c.require,10)&&0==c.pid&&(b.status=!0,b.desc="请选择"+a),b}var h=this;b.choseAdd&&$(".luckyselector").removeClass("location");var i=b.choseAdd||"请选择";b.choseAdd=null,c.readonly&&(i=""),h.getLocationName=function(a,b,c,d){function e(a,b,c){return a+" "+b+" "+c}var f=d||i;return""==a?f:e(a,b,c)};var j;e.get({loadingText:"加载中...",url:"jsonData/cityData.json",params:{},data:null}).then(function(a){j=window.myCity=a}),c.pName=c.pName||"",c.cName=c.cName||"",c.dName=c.dName||"",c.str=f(c.pName,c.cName,c.dName),c.readonly||(c.click=function(){a.show({title:c.name,initData:[c.pName,c.cName,c.dName],data:j}).then(function(a){c.pName=a[0],c.cName=a[1],c.dName=a[2]})}),c.$watch(function(){return c.pName+"-"+c.cName+"-"+c.dName},function(){c.str=f(c.pName,c.cName,c.dName),c.error&&(c.error[c.name]=g()),c.$emit("luckyStr",c.str)})}]}}]),LuckyUI.service("tripleSelectorPopup",["$rootScope","$q","overlay","$timeout",function(a,b,c,d){function e(){c.hide(),g.shown=0,a.$broadcast("triple-hide")}var f,g=this;this.shown=0,this.opts=null,this.show=function(d){return f=b.defer(),c.show(g.hide),g.shown=1,g.shown=1,g.opts=$.extend({title:"三栏选择器",initData:null,getRightListData:function(){},data:{}},d),a.$broadcast("triple-show"),f.promise},this.hide=function(){g.onCancel()},this.onConfirm=function(a){f&&g.shown&&(e(),d(function(){f.resolve(a)})),$(".luckyselector").removeClass("location")},this.onCancel=function(a){f&&g.shown&&(e(),d(function(){f.reject(a)}))}}]).directive("tripleSelectorPopup",["tripleSelectorPopup","$timeout",function(a,b){return{replace:!0,scope:!0,template:'<div id="triple-selector" class="luckypopup" ng-show="show"><header class="popup-header"><button class="blue fr" ng-click="_onConfirm();">确认</button><button class="fl" ng-click="_onCancel();">取消</button><div class="con">{{opts.title}}</div></header><div class="triple selector-body triple_selector_body"><div class="reticle"></div><ul class="level-1"><li ng-repeat="item in pOpts" ng-class="{\'active\':$index==0,\'unactive_3\':$index==1,\'unactive_4\':$index==2 || $index==3,\'unactive_5\':$index==4}" data-pName="{{item}}">{{item}}</li></ul><ul class="level-2"><li ng-repeat="item in cOpts" ng-class="{\'active\':$index==0,\'unactive_3\':$index==1,\'unactive_4\':$index==2 || $index==3,\'unactive_5\':$index==4}" data-cName="{{item}}">{{item}}</li></ul><ul class="level-3"><li ng-repeat="item in dOpts" ng-class="{\'active\':$index==0,\'unactive_3\':$index==1,\'unactive_4\':$index==2 || $index==3,\'unactive_5\':$index==4}" data-dName="{{item}}">{{item}}</li></ul></div></div>',restrict:"EA",controller:["$scope","$element","cm",function(c,d,e){function f(a,b,c){var d=-(a.height()-r);return!c&&d>b&&(b=(b+d)/2),!c&&b>0&&(b/=2),a.data("offset",b).css({"-webkit-transform":"translateY("+b+"px)","-transform":"translateY("+b+"px)"}),!0}function g(a){return a.data("offset")}function h(a){a.css({"-webkit-transition":"all ease 0.2s",transition:"all ease 0.2s"})}function i(a){a.css({"-webkit-transition":"none",transition:"none"})}function j(a){var b=a.now-a.start,c=1==a.side?u:2==a.side?v:w;c.find("li").removeClass("active unactive_0 unactive_1 unactive_2 unactive_3 unactive_4 unactive_5"),f(c,c.data("startOffset")+b)}function k(a){var b=1==a.side?u:2==a.side?v:w;b.stop(),b.data("start",!0),b.data("startOffset",g(b))}function l(a,c,d,e){if(c=Math.round(c/r),e||h(a),f(a,r*c),!e){var g=a.find("li").removeClass("active unactive_0 unactive_1 unactive_2 unactive_3 unactive_4 unactive_5");g.eq(1-c).addClass("unactive_3"),g.eq(-c-1).addClass("unactive_0"),g.eq(2-c).addClass("unactive_4"),g.eq(-c-2).addClass("unactive_0"),g.eq(3-c).addClass("unactive_5");var j=a.find("li").removeClass("active").eq(-c).addClass("active").attr("data-"+d);a.hasClass("level-1")&&m(-c,j),a.hasClass("level-2")&&n(-c,j),b(function(){i(a)},200)}e&&a.find("li").removeClass("active").eq(-c).addClass("active")}function m(a,b){c.cOpts=y(b,"c"),l(v,0,"cName",!0)}function n(a,b){c.dOpts=y(b,"d"),l(w,0,"dName",!0)}function o(){var a,b="北京市";return function(d,e){var f=[];return"c"===e?(b=d,angular.forEach(c.Opts[b],function(a,b){f.push(b)}),n(0,f[0]),f):"d"===e?(a=d,angular.forEach(c.Opts[b][a],function(a,b){f.push(a)})&&f):void 0}}function p(a){var b=1==a.side?u:2==a.side?v:w,c=1==a.side?"pName":2==a.side?"cName":"dName";b.data("start",!1);var d=-(b.height()-r),e=a.now-a.start,f=+new Date-a.startTime,g=(f+100)/f,h=b.data("startOffset")+e*g;h>0?l(b,0,c):d>h?l(b,d,c):l(b,h,c)}function q(){c.pOpts.length<=0&&angular.forEach(myCity,function(a,b){c.pOpts.push(b)}),!c.cOpts.length&&c.cOpts.push("北京市"),!c.dOpts.length&&(c.dOpts=myCity["北京市"]["北京市"])}var r=30,s=$(d),t=s.find(".triple_selector_body"),u=t.find(".level-1").data("offset",0),v=t.find(".level-2").data("offset",0),w=t.find(".level-3").data("offset",0),x=null;c.show=0,c.opts={},e.get({loadingText:"加载中...",url:"jsonData/cityData.json",params:{},data:null}).then(function(a){c.Opts=a}),c.pOpts=[],c.cOpts=[],c.dOpts=[];var y=o();c.$on("triple-show",function(){c.show=a.shown,c.onConfirm=a.onConfirm,c.onCancel=a.onCancel,c.opts=a.opts,s.removeClass("show"),s.removeAttr("style"),b(function(){q()},50),b(function(){s.addClass("show")},100)}),c.$on("triple-hide",function(){s.removeClass("show"),b(function(){c.show=0},100)}),c._onConfirm=function(){var b=[u.find(".active").attr("data-pName"),v.find(".active").attr("data-cName"),w.find(".active").attr("data-dName")];a.onConfirm(b)},c._onCancel=function(){a.onCancel(),c.pOpts=[],c.cOpts=[],c.dOpts=[],angular.forEach(myCity,function(a,b){c.pOpts.push(b)}),c.cOpts.push("北京市"),c.dOpts=myCity["北京市"]["北京市"],u.find(".active").removeClass("active"),v.find(".active").removeClass("active"),w.find(".active").removeClass("active"),u.find("li").eq(0).addClass("active"),v.find("li").eq(0).addClass("active"),w.find("li").eq(0).addClass("active"),f(u,0,!0),f(v,0,!0),f(w,0,!0)},s.on("touchmove",function(a){a.preventDefault()}),t.on("touchstart mousedown",function(a){var b,c=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;b=c.clientX<s.width()/3?1:c.clientX<s.width()/3*2?2:3,x={start:c.clientY,startTime:+new Date,side:b,now:c.clientY},k(x)}).on("touchend mouseup",function(){p(x),x=null}).on("touchmove mousemove",function(a){
var b=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;x&&(x.now=b.clientY,j(x))})}]}}]),LuckyUI.directive("myDateSelector",["dateTripleSelectorPopup",function(a){return{replace:!0,scope:{name:"@",error:"=",require:"@",readonly:"@"},template:'<span class="luckyselector" ng-click="click();">{{str}}</span>',restrict:"E",controller:["$scope","$element","$rootScope",function(b,c,d){function e(a,b,c){return h.getLocationName(a,b,c)}function f(){var a=b.name,c={status:!1,desc:""};return parseInt(b.require,10)&&0==b.pid&&(c.status=!0,c.desc="请选择"+a),c}function g(a){for(var b=+a-100,c=[],d=[],e=[];a>=b;a-=1)c.push(a+"年");for(var f=1;f<=12;f+=1)d.push(f+"月");for(var g=1;g<=31;g+=1)e.push(g+"日");return{year:c,month:d,day:e}}var h=this,i=d.birthDate||"1990-01-01";d.birthDate=null,b.readonly&&(i=""),h.getLocationName=function(a,b,c,d){function e(a,b,c){return b=b.slice(0,-1),c=c.slice(0,-1),a.slice(0,-1)+"-"+(b.length>1?b:"0"+b)+"-"+(c.length>1?c:"0"+c)}var f=d||i;return""==a?f:e(a,b,c)};var j=(new Date).getFullYear();window.myDate=g(j);var k=window.myDate;b.yName=b.yName||"",b.mName=b.mName||"",b.dName=b.dName||"",b.str=e(b.yName,b.mName,b.dName),b.readonly||(b.click=function(){a.show({title:b.name,initData:[b.yName,b.mName,b.dName],data:k}).then(function(a){b.yName=a[0],b.mName=a[1],b.dName=a[2]})}),b.$watch(function(){return b.yName+"-"+b.mName+"-"+b.dName},function(){b.str=e(b.yName,b.mName,b.dName),b.error&&(b.error[b.name]=f()),b.$emit("luckyDateStr",b.str)})}]}}]),LuckyUI.service("dateTripleSelectorPopup",["$rootScope","$q","overlay","$timeout",function(a,b,c,d){function e(){c.hide(),g.shown=0,a.$broadcast("triple-hide")}var f,g=this;this.shown=0,this.opts=null,this.show=function(d){return f=b.defer(),c.show(g.hide),g.shown=1,g.shown=1,g.opts=$.extend({title:"三栏选择器",initData:null,getRightListData:function(){},data:{}},d),a.$broadcast("triple-show"),f.promise},this.hide=function(){g.onCancel()},this.onConfirm=function(a){f&&g.shown&&(e(),d(function(){f.resolve(a)}))},this.onCancel=function(a){f&&g.shown&&(e(),d(function(){f.reject(a)}))}}]).directive("dateTripleSelectorPopup",["dateTripleSelectorPopup","$timeout",function(a,b){return{replace:!0,scope:!0,template:'<div id="triple-selector" class="luckypopup" ng-show="show"><header class="popup-header"><button class="blue fr" ng-click="_onConfirm();">确认</button><button class="fl" ng-click="_onCancel();">取消</button><div class="con">{{opts.title}}</div></header><div class="triple selector-body triple_selector_body date_selector_body"><div class="reticle"></div><ul class="level-1"><li ng-repeat="item in yOpts" ng-class="{\'active\':$index==0,\'unactive_3\':$index==1,\'unactive_4\':$index==2 || $index==3,\'unactive_5\':$index==4}" data-yName="{{item}}">{{item}}</li></ul><ul class="level-2"><li ng-repeat="item in mOpts" ng-class="{\'active\':$index==0,\'unactive_3\':$index==1,\'unactive_4\':$index==2 || $index==3,\'unactive_5\':$index==4}" data-mName="{{item}}">{{item}}</li></ul><ul class="level-3"><li ng-repeat="item in dOpts" ng-class="{\'active\':$index==0,\'unactive_3\':$index==1,\'unactive_4\':$index==2 || $index==3,\'unactive_5\':$index==4}" data-dName="{{item}}">{{item}}</li></ul></div></div>',restrict:"EA",controller:["$scope","$element",function(c,d){function e(a,b,c){var d=-(a.height()-r);return!c&&d>b&&(b=(b+d)/2),!c&&b>0&&(b/=2),a.data("offset",b).css({"-webkit-transform":"translateY("+b+"px)","-transform":"translateY("+b+"px)"}),!0}function f(a){return a.data("offset")}function g(a){a.css({"-webkit-transition":"all ease 0.2s",transition:"all ease 0.2s"})}function h(a){a.css({"-webkit-transition":"none",transition:"none"})}function i(a){var b=a.now-a.start,c=1==a.side?v:2==a.side?w:x;c.find("li").removeClass("active unactive_0 unactive_1 unactive_2 unactive_3 unactive_4 unactive_5"),e(c,c.data("startOffset")+b)}function j(a){var b=1==a.side?v:2==a.side?w:x;b.stop(),b.data("start",!0),b.data("startOffset",f(b))}function k(a,c,d,f){if(c=Math.round(c/r),f||g(a),e(a,r*c),!f){var i=a.find("li").removeClass("active unactive_0 unactive_1 unactive_2 unactive_3 unactive_4 unactive_5");i.eq(1-c).addClass("unactive_3"),i.eq(-c-1).addClass("unactive_0"),i.eq(2-c).addClass("unactive_4"),i.eq(-c-2).addClass("unactive_0"),i.eq(3-c).addClass("unactive_5");var j=a.find("li").removeClass("active").eq(-c).addClass("active").attr("data-"+d);a.hasClass("level-1")&&l(j),a.hasClass("level-2")&&m(j),b(function(){h(a)},200)}f&&a.find("li").removeClass("active unactive_0 unactive_1 unactive_2 unactive_3 unactive_4 unactive_5").eq(-c).addClass("active")}function l(a){s(a,"y")&&(c.dOpts=s(a,"y"))}function m(a){c.dOpts=s(a,"d")}function n(a){return a%4==0&&a%100!=0||a%100==0&&a%400==0}function o(){var a,b=new Date,d=b.getFullYear(),e=b.getMonth(),f=b.getDate(),g=d+"年",h=d,i=[4,6,9,11],j=myDate.month,l=myDate.day;return function(b,m){var o,p=+x.find(".active").attr("data-dName").slice(0,-1)-1;if("y"===m){if(g=b,(h=+b.slice(0,-1))==d)a>e+1&&k(w,0,"cName",!0),c.mOpts=j.slice(0,e+1),i.indexOf(a)>-1?c.dOpts=l.slice(0,-1):c.dOpts=l;else if(a==e+1&&(i.indexOf(a)>-1?c.dOpts=l.slice(0,-1):c.dOpts=l),c.mOpts=j,2==a)return n(h)?(o=l.slice(0,-2),p>=29&&k(x,-28*r,"dName",!0)):(o=l.slice(0,-3),p>=28&&k(x,-27*r,"dName",!0)),o;return!1}if("d"===m)return b=+b.slice(0,-1),a=b,h==d&&b==e+1?(o=l.slice(0,f),k(x,-(f-1)*r,"dName",!0)):2==b?n(h)?(o=l.slice(0,-2),p>=29&&k(x,-28*r,"dName",!0)):(o=l.slice(0,-3),p>=28&&k(x,-27*r,"dName",!0)):i.indexOf(b)>-1?(o=l.slice(0,-1),p>=30&&k(x,-29*r,"dName",!0)):o=l,o}}function p(a){var b=1==a.side?v:2==a.side?w:x,c=1==a.side?"yName":2==a.side?"mName":"dName";b.data("start",!1);var d=-(b.height()-r),e=a.now-a.start,f=+new Date-a.startTime,g=(f+100)/f,h=b.data("startOffset")+e*g;h>0?k(b,0,c):d>h?k(b,d,c):k(b,h,c)}function q(){var a=new Date,b=a.getFullYear();a.getMonth(),a.getDate();c.yOpts=myDate.year,c.mOpts=myDate.month.slice(0),c.dOpts=myDate.day,c.initYear||setTimeout(function(){k(v,-(b-1990)*r,"yName",!0),c.initYear=!0})}var r=30,s=o(),t=$(d),u=t.find(".triple_selector_body"),v=u.find(".level-1").data("offset",0),w=u.find(".level-2").data("offset",0),x=u.find(".level-3").data("offset",0),y=null;c.show=0,c.opts={},c.Opts=myCity,c.yOpts=[],c.mOpts=[],c.dOpts=[],c.initYear=!1,c.$on("triple-show",function(){c.show=a.shown,c.onConfirm=a.onConfirm,c.onCancel=a.onCancel,c.opts=a.opts,t.removeClass("show"),t.removeAttr("style"),b(function(){q()},50),b(function(){t.addClass("show")},100)}),c.$on("triple-hide",function(){t.removeClass("show"),b(function(){c.show=0},100)}),c._onConfirm=function(){var b=[v.find(".active").attr("data-yName"),w.find(".active").attr("data-mName"),x.find(".active").attr("data-dName")];a.onConfirm(b)},c._onCancel=function(){a.onCancel(),v.find(".active").removeClass("active"),w.find(".active").removeClass("active"),x.find(".active").removeClass("active"),v.find("li").eq(0).addClass("active"),w.find("li").eq(0).addClass("active"),x.find("li").eq(0).addClass("active"),e(v,0,!0),e(w,0,!0),e(x,0,!0)},t.on("touchmove",function(a){a.preventDefault()}),u.on("touchstart mousedown",function(a){var b,c=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;b=c.clientX<t.width()/3?1:c.clientX<t.width()/3*2?2:3,y={start:c.clientY,startTime:+new Date,side:b,now:c.clientY},j(y)}).on("touchend mouseup",function(){p(y),y=null}).on("touchmove mousemove",function(a){var b=a.originalEvent.touches?a.originalEvent.touches[0]:a.originalEvent;y&&(y.now=b.clientY,i(y))})}]}}]),orderDirectives.directive("dpFlight",function(){return{restrict:"EA",templateUrl:"./templates/directive/datePickerFlight.tpl.html",replace:!0,transclude:!0,scope:{dpConfig:"=dpConfig"},require:["dpFlight"],controller:"DPFlightController",controllerAs:"DPFlightController"}}).controller("DPFlightController",["$scope","$element","$http","$log","$cacheFactory","$location","cm",function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p=this,q=["周日","周一","周二","周三","周四","周五","周六"],r=[0,31,28,31,30,31,30,31,31,30,31,30,31],s=!0,t=[],u=a.dpConfig.url,v=a.dpConfig.title;p.goTripDateArr=null,p.backTripDateArr=null,p.dateType=null,p.renderType=null,p.title="",p.initDateObj=null,p.lastPriceDateObj=null,p.depart=a.dpConfig.depart,p.dest=a.dpConfig.dest,p.init=function(a){p.dateArray=[],s?p.requestData().success(function(){p.initialize(a)}):p.initialize(a)},p.initialize=function(a){h=p.getBeginDate(),j=p.getFormatDate(h),i=p.getEndDate(),k=p.getFormatDate(i),m=p.getRenderMonthCount(),l=p.getRenderEndDate(),p.setTitle(),p.renderDate(),s?p.initDate():p.open=a},p.initDate=function(){p.emitSelectDateEvent(p.initDateObj),p.open=!1},p.setTitle=function(){p.title=v},p.getRenderMonthCount=function(){var a=p.dateType,b=p.renderType;return!s&&("goTrip"!==a&&"backTrip"!==a||b)||(m=13),b&&(m=12*(i[0]-h[0])+(i[1]-h[1])+1),m=13},p.requestData=function(){var a=c({method:"get",url:u,params:{startDate:j,endDate:k},cache:!0});return a.success(function(a,b,c){n=a.data?a.data:[],o=c("date")||Date.now()}),a.error(function(a,b,c){}),a},a.$on("openGoTripDatePicker",function(a,b){p.openDatePicker(a,b,!0),p.renderType=null}),a.$on("openBackTripDatePicker",function(a,b){p.openDatePicker(a,b,!0),p.renderType=null}),a.$on("openGoDatePricePicker",function(a,b){p.openDatePicker(a,b,!0)}),a.$on("openBackDatePricePicker",function(a,b){p.openDatePicker(a,b,!0)}),a.$on("prevDay",function(a,b){d.info("前一天"),p.openDatePicker(a,b,!1),"goTrip"===p.dateType&&p.goTripPrevDay(),"backTrip"===p.dateType&&p.backTripPrevDay()}),a.$on("nextDay",function(a,b){d.info("后一天"),p.openDatePicker(a,b,!1),"goTrip"===p.dateType&&p.goTripNextDay(),"backTrip"===p.dateType&&p.backTripNextDay()}),p.goTripPrevDay=function(){var a,b=p.getStorageGoDateInfo(),c=b.curDateObj,d=c.dateArr;!p.dateCompare(h,d)||(a=p.getPrevDateObj(c),p.emitSelectDateEvent(a))},p.goTripNextDay=function(){var a,b=p.getStorageGoDateInfo(),c=b.curDateObj,d=c.dateArr,e=p.lastPriceDateObj;!p.dateCompare(d,e.dateArr)||(a=p.getNextDateObj(c),p.emitSelectDateEvent(a))},p.backTripPrevDay=function(){var a,b=p.getStorageBackDateInfo(),c=p.getStorageGoDateInfo(),d=b.curDateObj,e=c.curDateObj;d.index===e.index+1||(a=p.getPrevDateObj(d),p.emitSelectDateEvent(a))},p.backTripNextDay=function(){var a,b=p.getStorageBackDateInfo(),c=b.curDateObj,d=p.lastPriceDateObj;!p.dateCompare(c.dateArr,d.dateArr)||(a=p.getNextDateObj(c),p.emitSelectDateEvent(a))},p.openDatePicker=function(a,b,c){p.open=c,angular.isObject(b)&&(angular.isString(b.dateType)&&(p.dateType=b.dateType),angular.isString(b.renderType)&&(p.renderType=b.renderType)),p.init(c)},p.closeDatePicker=function(b){b&&f.path(b),p.open=!1,s=!1,a.$emit("closeDatePicker",{})},p.getDate=function(a){var b,c,d,e,f=new Date(o);if(angular.isUndefined(a))return b=f.getFullYear(),c=f.getMonth()+1,d=f.getDate(),e=f.getDay(),[b,c,d,e];if(angular.isObject(a)){var g,h,i,j,k,l,m=a.addType||"d",n=a.dateArr,p=a.addNum||1;switch(a.isBreak,b=n[0],c=n[1]-1,d=n[2],f=new Date(b,c,d),m){case"d":h=f.setDate(d+p);break;case"m":h=f.setMonth(c+p);break;case"y":h=f.setFullYear(b+p)}return g=new Date(h),k=g.getDate(),j=g.getMonth()+1,i=g.getFullYear(),l=g.getDay(),[i,j,k,l]}},p.getBeginDate=function(){return p.getDate()},p.getEndDate=function(){return p.getDate({dateArr:h,addNum:30})},p.getRenderEndDate=function(){return p.getDate({dateArr:h,addType:"y"})},p.renderDate=function(){var a,b,c,d,e,f,g,i,j,k,l,o,r,u,v,w,x,y,z,A=h[0],B=h[1],C=new Date,D=0,E=!1,F=angular.copy(n),G=0,H=!1,I=p.renderType,J=!1;s||(o=p.initDateObj.dateArr,r=p.getStorageBackDateInfo().curDateObj.dateArr);for(var K=0;K<m;K++){B>12&&(B=1,A++),p.dateArray[K]={year:A,month:B},C.setDate(1),C.setMonth(B-1),C.setFullYear(A),p.dateArray[K].dateObj=[],a=p.getDateIndex(A,B-1,1),b=a+p.getDaysInMonth(A,B);for(var L=0;L<b;L++)if(u=k=l=!1,L<a)p.dateArray[K].dateObj[L]={isUsable:E,renderDate:"",date:""};else{if(e=C.getFullYear(),d=C.getMonth(),c=i=C.getDate(),z=q[C.getDay()],f=[A,B,i],p.dateCompare(f,h)||(D=1,E=!0,J=!0),J){for(var M=F.length,N=!1,O=0;O<M;O++){v=F[O];var P=new Date(v.specDate),Q=P.getFullYear(),R=P.getMonth(),S=P.getDate();if(c==S&&d==R&&e==Q){N=!0;break}}N?(w=v.sellPrice,x=v.stock,g=v.displayType,y=v.stockFlag,u="DISPLAY_SOLD_OUT"===g,E=!u):E=!1}if(p.isSelectBackTrip()){var T=-1===p.dateCompare(f,o);E=I?T&&J:T,l=!p.dateCompare(f,r)&&E}else l=!p.dateCompare(f,o)&&E;switch(A===h[0]+1&&B===h[1]&&c>=h[2]&&(E=!1),D){case 1:z=c="今天",D++,k=!0;break;case 2:z=c="明天",D++,k=!0,H=!0;break;case 3:z=c="后天",D++,k=!0}if(localStorage.getItem("special_visitDate")||(l=!1),p.dateArray[K].dateObj[L]={isUsable:E,stock:x,stockFlag:y,renderDate:c,dateArr:f.concat([C.getDay()]),cnDay:z,displayType:g,dateFormat:p.getFormatDate(f),isHighLight:k,isSelected:l,isHasPrice:J,isSoldOut:u,price:w,dateArrIndex:K,index:G++},t.push(p.dateArray[K].dateObj[L]),C.setDate(C.getDate()+1),f=null,s&&H){var U=p.getStorageGoDateInfo();p.initDateObj=U?U.curDateObj:p.dateArray[K].dateObj[L],H=null}}B++,j=p.getDateIndex(A,B-1,0);for(var V=0;V<6-j;V++)p.dateArray[K].dateObj[L+V]={isUsable:!1,renderDate:"",date:""}}},p.dateCompare=function(a,b){var c,d;return angular.isArray(a)&&(c=p.dateArrToMs(a)),angular.isArray(b)&&(d=p.dateArrToMs(b)),c===d?0:c<d?1:-1},p.dateArrToMs=function(a){return new Date(a[0],a[1]-1,a[2]).getTime()},p.hasGoTripDateObj=function(){var a,b=p.getStorageGoDateInfo();if(angular.isObject(b))return a=b.curDateObj,angular.isObject(a)},p.hasBackTripDateObj=function(){var a,b=p.getStorageBackDateInfo();return angular.isObject(b)&&(a=b.curDateObj),angular.isObject(a)},p.getStorageGoDateInfo=function(){var a,b=angular.fromJson(localStorage.getItem("datePickerData"));if(angular.isObject(b)&&(a=b.goDateInfo,angular.isObject(a)))return a},p.getStorageBackDateInfo=function(){var a,b=angular.fromJson(localStorage.getItem("datePickerData"));if(angular.isObject(b)&&(a=b.backDateInfo,angular.isObject(a)))return a},p.isSelectBackTrip=function(){return"backTrip"===p.dateType},p.getFormatDate=function(a,b,c){var d,e;if(3===arguments.length)return d=b<10?"0"+b:b,e=c<10?"0"+c:c,a+"-"+d+"-"+e;if(1===arguments.length&&angular.isArray(a)){var f=a[0],g=a[1],h=a[2];return p.getFormatDate(f,g,h)}},p.selectDate=function(a,c){if(a.isUsable){var d=c.target,e=angular.element(d),f="selected",g=b.find("article"),h=g.find("span");if("SPAN"===d.nodeName.toLocaleUpperCase()){if(e.hasClass(f))return;h.removeClass(f),e.addClass(f)}p.emitSelectDateEvent(a)}},p.emitSelectDateEvent=function(b){var c,d,e,f,g;p.isSelectBackTrip()?(f=p.getStorageGoDateInfo(),c=angular.isObject(f)?f.curDateObj:p.initDateObj,e=b):(c=b,p.isGoDateOverBack(c)?e=p.getBackDateObj(c):(g=p.getStorageBackDateInfo(),e=angular.isObject(g)?g.curDateObj:p.getBackDateObj())),d={goDateInfo:{curDateObj:c,preDateObj:p.getPrevDateObj(c),nextDateObj:p.getNextDateObj(c)},backDateInfo:{curDateObj:e,preDateObj:p.getPrevDateObj(e),nextDateObj:p.getNextDateObj(e)}},p.setDateObjCache(d),s?d.isInit=!0:(p.updateInitDateObj(),d.isInit=!1),p.closeDatePicker(),a.$emit("onSelectDate",d)},p.updateInitDateObj=function(){var a=p.getStorageGoDateInfo();angular.isObject(a)&&(p.initDateObj=a.curDateObj)},p.getPrevDateObj=function(a){var b=a.index,c=b-1;return p.getDateObjByIndex(c)},p.getNextDateObj=function(a){var b=a.index,c=b+1;return p.getDateObjByIndex(c)},p.getDateObjByIndex=function(a){for(var b,c,d=t.length,e=0;e<d;e++)if(b=t[e],c=b.index,angular.isNumber(c)&&a===c)return b},p.setDateObjCache=function(a){p.emitData=a,localStorage.setItem("datePickerData",angular.toJson(a))},p.isGoDateOverBack=function(a){var b,c,d,e;if(g.isNotEmpty(a)&&g.isNotEmpty(a.index)&&(b=a.index),p.hasBackTripDateObj()?(d=p.getStorageBackDateInfo(),e=d.curDateObj.index):(c=p.getBackDateObj(),e=c.index),b>=e)return!0},p.getBackDateObj=function(a){var b=a||p.initDateObj,c=b.index,d=c+2;return p.getDateObjByIndex(d)},p.getDateIndex=function(a,b,c){return new Date(a,b,c).getDay()},p.getDaysInMonth=function(a,b){return 2===b&&a%4==0&&a%100==0||a%400==0?29:r[b]},s&&p.init()}]),orderControllers.controller("addressAddCtrl",["$scope","addressAddService","$timeout","$location",function(a,b,c,d){var e=window.localStorage,f={getText:function(a){return(a.target||a.srcElement).innerText},getTarget:function(a){return a.target||a.srcElement}},g="";a.param={maskShow:!1,errorMsg:null,showErrMsg:!1},a.model={recipientName:null,mobileNumber:null,province:null,city:null,address:null,postCode:null},a.fn={showErr:function(a){return h.errorMsg=a,h.showErrMsg=!0,c(function(){h.showErrMsg=!1},2e3),!1},goAddressChoose:function(){d.path("/addressChoose")},commit:function(){var c=a.model;b.validate(h,"errorMsg","showErrMsg")&&b.getUser().then(function(a){var f=a.data.userId;void 0!=f&&null!=f?b.addAddress(c).then(function(a){var b=JSON.parse(e.getItem("order_address"))||[];c.receiverId=a.data.receiverId,b.push(c),e.setItem("order_address",JSON.stringify(b)),d.path("/addressChoose")},function(a){}):i.goClutter()},function(a){i.goClutter()})},init:function(a){jsonpCallBack=function(a){g=i.formatData(a.data.tree)},b.getCity().then(jsonpCallBack)},formatData:function(a){for(var b={title:"选择所在地区",isActive:!0,colCount:2,colOptions:[{widthPercent:50,align:"center",defaultCode:2e3},{widthPercent:50,align:"center",defaultCode:2e3}]},c=[],d=2e3,e=1,f=a.length;e<f;e+=1){var g={};g.key=a[e].key,g.code=d,g.name=a[e].value,g.column=1,g.pCode=null,c.push(g);for(var h=0,i=a[e].list.length;h<i;h+=1){var g={};g.key=a[e].list[h].key||0,g.name=a[e].list[h].value,g.column=2,g.pCode=d,c.push(g)}d++}return b.data=c,b},getCitySelect:function(b){var c=new SpinWheel,d=f.getTarget(b);c.setData(g),c.setCancelAction(function(){d.value=null}),c.setDoneAction(function(){var b=c.getSelectedValues();if(0==b.keys[1])return $("#triggerErr")[0].click(),!0;d.value=b.values.join(" "),console.log(b),a.model.province=b.values[0],a.model.city=b.values[1],a.model.provinceId=b.ids[0],a.model.cityId=b.ids[1]}),c.open()},goClutter:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent($window.location.href)},triggerErr:function(){return i.showErr("请选择省份和城市")}};var h=a.param,i=a.fn;i.init()}]),orderServices.factory("addressAddService",["cm",function(a){return{addAddress:function(b){return b.lvsessionid=a.commonParams&&a.commonParams.lvsessionid,a.post({loadingText:"加载中...",url:a.getUrls().addAddress,params:b})},getCity:function(b){return a.getJSON({loadingText:"加载中...",url:a.getUrls().getCity,params:b})},getUser:function(){var b={version:"1.0.0",lvsessionid:a.commonParams&&a.commonParams.lvsessionid,format:"json"};return a.get({loadingText:"加载中...",url:a.getUrls().getUser,params:b})},validate:function(b,c,d,e){return a.validate(b,c,d,e)}}}]),orderControllers.controller("addressChooseCtrl",["$scope","addressChooseService","$location","$window","dataManager",function(a,b,c,d,e){var f=window.localStorage,g=e.getData("special_order");a.param={errorMsg:!1,address:null},jsonpCallBack=function(a){h.address=a.data},a.fn={getAddress:function(){b.getUser().then(function(a){var c=a.data.userId;void 0!=c&&null!=c?b.getAddress().then(jsonpCallBack):i.goClutter()},function(a){i.goClutter()})},goAddressAdd:function(){c.path("/addressAdd")},goAddressEdit:function(a){f.setItem("order_address",JSON.stringify(h.address)),f.setItem("order_address_index",a),c.path("/addressEdit")},toggleChoose:function(a){h.address[a].isChecked=!h.address[a].isChecked,a!=h.prevIndex&&null!=h.prevIndex&&(h.address[h.prevIndex].isChecked=!1),h.prevIndex=a},finish:function(){var a=h.address[h.prevIndex];g&&(g.addressName=a.recipientName,g.addressMobile=a.mobileNumber,g.addressAddress=a.address,g.addressProvince=a.province,g.provinceId=a.provinceId,g.cityId=a.cityId,g.addressCity=a.city,g.addressPC=g.addressProvince+" "+g.addressCity,g.zipCode=a.postCode),g.unload=!0,c.path("special")},goClutter:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent(d.location.href)},goSpecial:function(){g.unload=!0,c.path("special")}};var h=a.param,i=a.fn;i.getAddress()}]),orderServices.factory("addressChooseService",["cm",function(a){return{getAddress:function(){return a.get({loadingText:"加载中...",url:a.getUrls().getAddress,params:{lvsessionid:a.commonParams&&a.commonParams.lvsessionid}})},getUser:function(){var b={version:"1.0.0",lvsessionid:a.commonParams&&a.commonParams.lvsessionid,format:"json"};return a.get({loadingText:"加载中...",url:a.getUrls().getUser,params:b})}}}]),orderControllers.controller("addressEditCtrl",["$scope","addressEditService","$timeout","$location","$rootScope",function(a,b,c,d,e){var f=window.localStorage,g="",h={getText:function(a){return(a.target||a.srcElement).innerText},getTarget:function(a){return a.target||a.srcElement}};a.param={errorMsg:null,showErrMsg:!1,index:null,receiverId:null,addressNo:null},a.model={},a.fn={showErr:function(a){i.errorMsg=a,i.showErrMsg=!0,c(function(){i.showErrMsg=!1},2e3)},goAddressChoose:function(){d.path("/addressChoose")},getAddressInfo:function(){var b,c=JSON.parse(f.getItem("order_address")),d=i.index=f.getItem("order_address_index");b=a.model=c[d],i.addressNo=b.addressNo,a.address=b.province+" "+b.city},commit:function(){var c=a.model;b.validate(i,"errorMsg","showErrMsg")&&b.getUser().then(function(a){var e=a.data.userId;void 0!=e&&null!=e?b.updateAddress(c).then(function(a){var b=JSON.parse(f.getItem("order_address"));b.splice(i.index,1),f.setItem("order_address",JSON.stringify(b)),f.setItem("order_address_index",null),d.path("/addressChoose")},function(a){}):j.goClutter()},function(a){j.goClutter()})},init:function(a){jsonpCallBack=function(a){g=j.formatData(a.data.tree)},b.getCity().then(jsonpCallBack)},formatData:function(a){for(var b={title:"选择所在地区",isActive:!0,colCount:2,colOptions:[{widthPercent:50,align:"center",defaultCode:2e3},{widthPercent:50,align:"center",defaultCode:2e3}]},c=[],d=2e3,e=1,f=a.length;e<f;e+=1){var g={};g.key=a[e].key,g.code=d,g.name=a[e].value,g.column=1,g.pCode=null,c.push(g);for(var h=0,i=a[e].list.length;h<i;h+=1){var g={};g.key=a[e].list[h].key||0,g.name=a[e].list[h].value,g.column=2,g.pCode=d,c.push(g)}d++}return b.data=c,b},getCitySelect:function(b){var c=new SpinWheel,d=h.getTarget(b);c.setData(g),c.setCancelAction(function(){d.value=null}),c.setDoneAction(function(){var b=c.getSelectedValues();if(0==b.keys[1])return $("#triggerErr")[0].click(),!0;a.model.province=b.values[0],a.model.city=b.values[1],a.model.provinceId=b.ids[0],a.model.cityId=b.ids[1],d.value=b.values.join(" ")}),c.open()},triggerErr:function(){return j.showErr("请选择省份和城市")},goClutter:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent($window.location.href)},remove:function(){b.removeAddress({addressNo:i.addressNo,receiversType:"Address"}).then(function(a){var b=JSON.parse(f.getItem("order_address"));b.splice(i.index,1),f.setItem("order_address",JSON.stringify(b)),f.setItem("order_address_index",null),d.path("/addressChoose")},function(a){})}};var i=a.param,j=a.fn;j.init(),j.getAddressInfo()}]),orderServices.factory("addressEditService",["cm",function(a){return{updateAddress:function(b){return b.lvsessionid=a.commonParams&&a.commonParams.lvsessionid,a.post({loadingText:"加载中...",url:a.getUrls().updateAddress,params:b})},removeAddress:function(b){return b.lvsessionid=a.commonParams&&a.commonParams.lvsessionid,a.post({loadingText:"加载中...",url:a.getUrls().removeAddress,params:b})},getCity:function(b){return a.getJSON({loadingText:"加载中...",url:a.getUrls().getCity,params:b})},getUser:function(){var b={version:"1.0.0",lvsessionid:a.commonParams&&a.commonParams.lvsessionid,format:"json"};return a.get({loadingText:"加载中...",url:a.getUrls().getUser,params:b})},validate:function(b,c,d,e){return a.validate(b,c,d,e)}}}]),orderControllers.controller("bookerAddCtrl",["$scope","bookerAddService","$timeout","$location","cm","$window",function(a,b,c,d,e,f){var g=window.localStorage,h={getText:function(a){return(a.target||a.srcElement).innerText},reset:function(a){null}},i={"身份证":"ID_CARD","护照":"HUZHAO","港澳通行证":"GANGAO","台湾通行证":"TAIBAO"},j={"男":"MALE","女":"FEMALE"};a.param={sortType:[],selectedType:null,cardType:"身份证",genderType:null,maskShow:!1,errorMsg:null,showErrMsg:!1},a.model={receiverName:null,mobileNumber:null,birthday:null,email:null,firstName:null,lastName:null,certType:"ID_CARD",certNo:null,receiverGender:null,peopleType:"ADULT"},a.fn={showType:function(a){k.selectedType=a.toLowerCase(),"CARD"===a?k.sortType=["身份证","护照","港澳通行证","台湾通行证"]:"GENDER"===a&&(k.sortType=["男","女"]),k.maskShow=!0},hideMask:function(){k.maskShow=!1},selectType:function(a){k[k.selectedType+"Type"]=h.getText(a),k.maskShow=!1},showErr:function(a){return k.errorMsg=a,k.showErrMsg=!0,c(function(){k.showErrMsg=!1},2e3),!1},goBookerChoose:function(){d.path("/bookerChoose")},commit:function(){var c=a.model;c.certType=i[k.cardType],c.receiverGender=j[k.genderType],b.validate(k,"errorMsg","showErrMsg")&&b.getUser().then(function(a){var e=a.data.userId;void 0!=e&&null!=e?b.addContact(c).then(function(a){var b=JSON.parse(g.getItem("order_bookers"))||[];c.receiverId=a.data.receiverId,b.push(c),g.setItem("order_bookers",JSON.stringify(b)),h.reset(b),d.path("/bookerChoose")},function(a){}):l.goClutter()},function(a){l.goClutter()})},goClutter:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent(f.location.href)}};var k=a.param,l=a.fn;a.model;a.$on("luckyDateStr",function(b,c){a.model.birthday=c})}]),orderServices.factory("bookerAddService",["cm",function(a){return{addContact:function(b){return b.lvsessionid=a.commonParams&&a.commonParams.lvsessionid,a.post({loadingText:"加载中...",url:a.getUrls().addContact,params:b})},getUser:function(){var b={version:"1.0.0",lvsessionid:a.commonParams&&a.commonParams.lvsessionid,format:"json"};return a.get({loadingText:"加载中...",url:a.getUrls().getUser,params:b})},validate:function(b,c,d,e){return a.validate(b,c,d,e)}}}]),orderControllers.controller("bookerChooseCtrl",["$scope","bookerChooseService","$location","$timeout","$window","dataManager","cm",function(a,b,c,d,e,f,g){var h,i,j=window.localStorage,k=f.getData("special_order")||{},l={"身份证":"ID_CARD","护照":"HUZHAO","港澳通行证":"GANGAO","台湾通行证":"TAIBAO"};a.param=h={errorMsg:null,showErrMsg:!1,bookers:null,prevIndex:null,title:"CONTACT"===k.personType?"选择预订人":"选择游玩人",addTitle:"CONTACT"===k.personType?"新增预订人":"新增游玩人"},a.fn=i={getBookers:function(){b.getUser().then(function(a){var c=a.data.userId;void 0!=c&&null!=c?b.getContact().then(function(a){h.bookers=a.data,g.isNotEmpty(h.bookers)&&h.bookers.forEach(function(a){for(var b in l)if(l[b]===a.certType){a.certType=b;break}})}):i.goClutter()},function(a){i.goClutter()})},showErr:function(a){return h.errorMsg=a,h.showErrMsg=!0,d(function(){h.showErrMsg=!1},2e3),!1},goBookerAdd:function(){c.path("/bookerAdd")},goBookerEdit:function(a){j.setItem("order_bookers",JSON.stringify(h.bookers)),j.setItem("order_booker_index",a),c.path("/bookerEdit")},toggleChoose:function(a){h.bookers[a].isChecked=!h.bookers[a].isChecked,a!=h.prevIndex&&null!=h.prevIndex&&(h.bookers[h.prevIndex].isChecked=!1),h.prevIndex=a},finish:function(){for(var a,b=[],d="CONTACT"===k.personType,e="PLAYER"===k.personType,f=0,g=h.bookers.length;f<g;){var j=h.bookers[f++];j.isChecked&&b.push(j)}if(!(a=b.length))return i.showErr("请选择预订人");if(d&&a>1)return i.showErr("预订人数不能超过1人");if(e&&a>9)return i.showErr("游玩人数不能超过9人");if(d){var j=b[0];k.contactName=j.receiverName,k.contactMobile=j.mobileNumber,k.contactFirstName=j.firstName,k.contactLastName=j.lastName,k.contactEmail=j.email,k.contactIdType="ID_CARD",k.contactIdTypeCn=j.certType,"ID_CARD"===l[j.certType]&&(k.contactIdNo=j.certNo),k.contactGender=j.receiverGender,k.contactBirth=j.birthday}else if(e){var j=b[0],m=k.personIndex;"travellerNames"in k||(k.travellerNames=[],k.travellerMobiles=[],k.travellerFirstNames=[],k.travellerLastNames=[],k.travellerEmails=[],k.travellerIdTypes=[],k.travellerIdNos=[],k.travellerGenders=[],k.travellerBirths=[],k.IdTypesCn=[]),k.travellerNames[m]=j.receiverName,k.travellerMobiles[m]=j.mobileNumber,k.travellerFirstNames[m]=j.firstName,k.travellerLastNames[m]=j.lastName,k.travellerEmails[m]=j.email,k.travellerIdTypes[m]=l[j.certType],k.IdTypesCn[m]=j.certType,k.travellerIdNos[m]=j.certNo,k.travellerGenders[m]=j.receiverGender,k.travellerBirths[m]=j.birthday}k.unload=!0,c.path("special")},goClutter:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent(e.location.href)},goSpecial:function(){k.unload=!0,c.path("special")}},i.getBookers()}]),orderServices.factory("bookerChooseService",["cm",function(a){return{getContact:function(){return a.get({loadingText:"加载中...",url:a.getUrls().getContact,params:{lvsessionid:a.commonParams&&a.commonParams.lvsessionid}})},getUser:function(){var b={version:"1.0.0",lvsessionid:a.commonParams&&a.commonParams.lvsessionid,format:"json"};return a.get({loadingText:"加载中...",url:a.getUrls().getUser,params:b})}}}]),orderControllers.controller("bookerEditCtrl",["$scope","bookerEditService","$timeout","$location","$rootScope","$window",function(a,b,c,d,e,f){var g=window.localStorage,h={getText:function(a){return(a.target||a.srcElement).innerText},reset:function(a){null}},i={"身份证":"ID_CARD","护照":"HUZHAO","港澳通行证":"GANGAO","台湾通行证":"TAIBAO"},j={"男":"MALE","女":"FEMALE"},k={PEOPLE_TYPE_ADULT:"ADULT",PEOPLE_TYPE_CHILD:"CHILD"};a.param={sortType:[],selectedType:null,cardType:"身份证",genderType:null,maskShow:!1,errorMsg:null,showErrMsg:!1,receiverId:null,index:null},a.model={},a.fn={showType:function(a){l.selectedType=a.toLowerCase(),"CARD"===a?l.sortType=["身份证","护照","港澳通行证","台湾通行证"]:"GENDER"===a&&(l.sortType=["男","女"]),l.maskShow=!0},hideMask:function(){l.maskShow=!1},selectType:function(a){l[l.selectedType+"Type"]=h.getText(a),l.maskShow=!1},showErr:function(a){return l.errorMsg=a,l.showErrMsg=!0,c(function(){l.showErrMsg=!1},2e3),!1},goBookerChoose:function(){d.path("/bookerChoose")},getBookerInfo:function(){var b,c,d,f=JSON.parse(g.getItem("order_bookers")),i=l.index=g.getItem("order_booker_index");d=a.model=f[i],b=d.certType,c=d.receiverGender,l.cardType=b,l.receiverId=d.receiverId,e.birthDate=d.birthday;for(var k in j)if(j[k]===c){d.receiverGender=k,l.genderType=k;break}h.reset(f)},commit:function(){var c=a.model;c.certType=i[l.cardType],c.receiverGender=j[l.genderType],c.peopleType=k[c.peopleType],b.validate(l,"errorMsg","showErrMsg")&&b.getUser().then(function(e){var f=e.data.userId;void 0!=f&&null!=f?b.updateContact(c).then(function(b){var c=JSON.parse(g.getItem("order_bookers"));c[l.index]=a.model,g.setItem("order_bookers",JSON.stringify(c)),g.setItem("order_booker_index",null),h.reset(c),d.path("/bookerChoose")},function(a){}):m.goClutter()},function(a){m.goClutter()})},remove:function(){b.getUser().then(function(a){var c=a.data.userId;void 0!=c&&null!=c?b.removeContact({receiverId:l.receiverId,receiversType:"Contact"}).then(function(a){var b=JSON.parse(g.getItem("order_bookers"));b.splice(l.index,1),g.setItem("order_bookers",JSON.stringify(b)),g.setItem("order_booker_index",null),d.path("/bookerChoose")},function(a){}):m.goClutter()},function(a){m.goClutter()})},goClutter:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent(f.location.href)}};var l=a.param,m=a.fn;m.getBookerInfo(),a.$on("luckyDateStr",function(b,c){a.model.birthday=c})}]),orderServices.factory("bookerEditService",["cm",function(a){return{updateContact:function(b){return b.lvsessionid=a.commonParams&&a.commonParams.lvsessionid,a.post({loadingText:"加载中...",url:a.getUrls().updateContact,params:b})},removeContact:function(b){return b.lvsessionid=a.commonParams&&a.commonParams.lvsessionid,a.post({loadingText:"加载中...",url:a.getUrls().removeContact,params:b})},getUser:function(){var b={version:"1.0.0",lvsessionid:a.commonParams&&a.commonParams.lvsessionid,format:"json"};return a.get({loadingText:"加载中...",url:a.getUrls().getUser,params:b})},validate:function(b,c,d,e){return a.validate(b,c,d,e)}}}]),
orderControllers.controller("couponCtrl",["$scope","couponService","$location","$timeout","$window","dataManager",function(a,b,c,d,e,f){function g(){b.getCoupon().then(function(a){h.coupon=a.data})}var h,i,j=(window.localStorage,f.getData("special_order")||{});g(),a.param=h={},a.DATA=j,a.fn=i={goClutter:function(){},goSpecial:function(){c.path("special")},validate:function(){b.countTicketPrice(j).then(function(a){},function(a){})},useCoupon:function(a){var b=h.coupon[a];j.couponCode=b.code,j.price=b.price,i.goSpecial()}}}]),orderServices.factory("couponService",["cm","$location",function(a,b){var c=b.search();return{getCoupon:function(){return a.get({loadingText:"加载中...",url:a.getUrls().getCoupon,params:{}})},countTicketPrice:function(b){return angular.extend(b,c),a.get({loadingText:"加载中...",url:a.getUrls().countTicketPrice,params:b})}}}]),orderControllers.controller("datePickCtrl",["$scope","$log","$location","dataManager","cm",function(a,b,c,d,e){a.openGoDatePricePicker=function(){a.$broadcast("openGoDatePricePicker",{dateType:"goTrip",renderType:"goDatePrice"})};var f="";e.isNotEmpty(e.commonParams.combProductId)&&(f="&combProductId="+e.commonParams.combProductId),e.isNotEmpty(e.commonParams.saleChannel)||(e.commonParams.saleChannel=null);var g="";if(e.commonParams.goodsIds){var h=e.commonParams.goodsIds+"",i=[];i=h.split(",");for(var j=0;j<i.length;j++)g=g+"&goodsId="+i[j]}console.log(e.commonParams),a.dpConfig={url:e.getUrls().getGoodsTimePrice+"&lvsessionid="+e.commonParams.lvsessionid+"&productId="+e.commonParams.productId+g+f+"&branchType="+e.commonParams.branchType+"&saleChannel="+e.commonParams.saleChannel,title:"选择日期"},a.$on("onSelectDate",function(a,b){!b.isInit&&c.path("special");var e=b.goDateInfo.curDateObj,f=d.getData("special_order");try{f.visitDates=e.dateFormat,f.visitDay=e.cnDay,f.stock=e.stock,f.price=e.price,f.stockFlag=e.stockFlag}catch(g){c.path("special")}})}]),orderControllers.controller("insure",["$scope","$routeParams","$location","cm","$window","dataManager","$timeout","$sce",function(a,b,c,d,e,f,g,h){var i;a.param={},a.model=i={isAndroid:navigator.userAgent.indexOf("Android")>-1,acInsureIndex:c.search().acInsureIndex,reInsureIndex:c.search().reInsureIndex,insureData:JSON.parse(localStorage.getItem("special_insures"))},i.accidentInsurance=i.insureData.accidentInsurance,i.retirementInsurance=i.insureData.retirementInsurance,a.fn={goBack:function(){c.path("special")},backToOrder:function(){c.search().acInsureIndex=i.acInsureIndex,c.search().reInsureIndex=i.reInsureIndex,c.path("special")},choseInsure:function(a,b){"accident"==b?i.acInsureIndex=a:"retirement"==b&&(i.reInsureIndex=a)},showNotice:function(a,b){"accident"==b?(i.currentDesc=i.accidentInsurance[a].desc,i.curentTitle=i.accidentInsurance[a].insuranceName):"retirement"==b&&(i.currentDesc=i.retirementInsurance[a].desc,i.curentTitle=i.retirementInsurance[a].insuranceName),b&&(i.currentDescHTML=h.trustAsHtml(i.currentDesc.replace(/pt/g,"px"))),i.insureNoticeShow=!i.insureNoticeShow}}}]),orderControllers.controller("ticketOrderInputCtrl",["$scope","ticketOrderInputService","$timeout","$location","$rootScope","$window","dataManager","cm","$sce",function(a,b,c,d,e,f,g,h,i){function j(){J.setItem("special_insureSelected",JSON.stringify({retirementInsurance:C.retirementInsurance,accidentInsurance:C.accidentInsurance,currentReInsure:C.currentReInsure,currentAcInsure:C.currentAcInsure,reInsureIndex:C.reInsureIndex,acInsureIndex:C.acInsureIndex,reInsureSelected:C.reInsureSelected,acInsureSelected:C.acInsureSelected,retreatInsurId:C.retreatInsurId,unExpInsurId:C.unExpInsurId}))}function k(){var a=c(function(){C.second=C.second-1,C.second>0?k():(c.cancel(a),C.countDown=!1,C.second=60)},1e3)}function l(){b.getUser().then(function(a){I=h.getCookie("lvsessionid")||"",1==a.code&&(C.isLogin=!0),C.imgCodeUrl="//m.lvmama.com/usso/router/rest.do?method=api.com.validateCode.createNewValidateCode&version=1.0.0&lvversion=7.10.3&lvsessionid="+I,m()},function(a){C.imgCodeUrl="//m.lvmama.com/usso/router/rest.do?method=api.com.validateCode.createNewValidateCode&version=1.0.0&lvversion=7.10.3&lvsessionid="+I,m()})}function m(){b.inputTicketOrder({}).then(function(a){if(1==a.code){C.entityTicketFlag=a.data.entityTicketFlag,C.entityTicketFlag&&u(),"travellerNames"in E||(E.travellerNames=[],E.travellerMobiles=[],E.travellerFirstNames=[],E.travellerLastNames=[],E.travellerEmails=[],E.travellerIdTypes=[],E.travellerIdNos=[],E.travellerGenders=[],E.travellerBirths=[],E.IdTypesCn=[]),h.isNotEmpty(a.data)&&h.isNotEmpty(a.data.seckillRuleId)&&(C.seckillPk=a.data.seckillRuleId),h.isNotEmpty(a.data)&&h.isNotEmpty(a.data.saleChannel)&&(C.saleChannel=a.data.saleChannel),d.search().saleChannel=C.saleChannel;var b,c,e=a.data;if(C.inpTickOrder=e,C.allowApply=a.data.isInvoice&&a.data.showInvoice,J.getItem("H5specialTicket_invoiceApply")||(C.invoiceBasicInfoVo=a.data.orderPersonInvoiceInfoVo||{},C.invoiceBasicInfoVo.invoiceType=0),h.getUrlParam("combProductId")){b=C.inpTickOrder.combProductDetailVo,C.packageCount=[],E.goodsIds=[];for(var f in b.clientTicketGoodsVos)E.goodsIds.push(b.clientTicketGoodsVos[f].suppGoodsId),C.packageCount.push(b.clientTicketGoodsVos[f].packageCount)}else h.isNotEmpty(C.inpTickOrder)&&h.isNotEmpty(C.inpTickOrder.clientTicketGoodsDetailVo)&&(b=C.inpTickOrder.clientTicketGoodsDetailVo),E.goodsIds=h.getUrlParam("goodsIds");if(b){C.clientDetail=b,C.priceIncludes=t(b.priceIncludes),C.beforeTralNotice=t(b.beforeTralNotice),C.importantTips=t(b.importantTips),C.refundNotice=t(b.refundNotice),!E.quantities&&(C.quantities=b.minQuantity),c=b.secondTagItems;for(var f in c)if("refund"===c[f].tagType){C.tagType="refund",C.secTagItemName=c[f].name;break}}h.isNotEmpty(e)&&h.isNotEmpty(e.hasDiscountCoupon)&&(E.hasDiscountCoupon=C.hasDiscountCoupon=e.hasDiscountCoupon),E.price&&C.clientDetail&&(C.clientDetail.sellPrice=E.price),!E.contactName&&h.isNotEmpty(e)&&(h.isNotEmpty(e)&&h.isNotEmpty(e.contactName)&&(E.contactName=e.contactName),E.contactMobile=e.contactMobile||"",E.contactIdNo=e.contactIdNo||""),"PLAYER"===E.personType&&(C.cardSelect=E.IdTypesCn),C.clientDetail&&o(),n(),e&&setTimeout(function(){var a;a=e.clientTicketGoodsDetailVo?e.clientTicketGoodsDetailVo:e.combProductDetailVo;C.saleChannel,e.cmProductType;statisticsUtil.losc.cmCreatePageviewTag("order",{pi:a.productId,ci:e.bizCategoryId,ss:!0}),statisticsUtil.siteIDs=["JQWL","TM"],"undefined"!=typeof statisticsUtil&&statisticsUtil.execStatis("page",{pi:e.cmInfoVO.pageId,cg:e.cmInfoVO.categoryId,attributes:"-_--_--_-其他页面"})})}},function(a){})}function n(){b.getInputOptions({goodsIds:E.goodsIds}).then(function(a){if(a.data){C.needOptions=a.data.option;var b=["needIdcard","passportFlag","passFlag","twPassFlag","twResidentFlag","hkResidentFlag"],c=["身份证","护照","港澳通行证","台湾通行证","台胞证","回乡证"];C.ableCertTypes=[],C.certName=C.certName||"";for(var d=0;d<b.length;d++)C.needOptions[b[d]]&&(C.ableCertTypes.push(c[d]),C.certName||(C.certName=c[d],E.contactIdType=G[c[d]],["HUZHAO","GANGAO","TAIBAO"].indexOf(E.contactIdType)>-1?C.specialCert=!0:C.specialCert=!1));var e=JSON.parse(J.getItem("special_booker"));e&&(E.contactName=e[0].receiverName,E.contactMobile=e[0].mobileNumber,E.contactEmail=e[0].email,E.contactIdNo=e[0].certNo,C.ableCertTypes.indexOf(e[0].certType)>-1&&(C.certName=e[0].certType,E.contactIdType=G[e[0].certType]),J.setItem("special_booker_choose",JSON.stringify([e[0].receiverId]))),J.removeItem("specialBooker_fill");var f={birthFlag:C.specialCert,emailFlag:C.specialCert,faxFlag:!!C.needOptions.faxFlag,firstNameFlag:!!C.needOptions.firstNameFlag,fullNameFlag:!0,genderFlag:!!C.needOptions.genderFlag,hkResidentFlag:!!C.needOptions.hkResidentFlag,idFlag:!!C.needOptions.needIdcard,lastNameFlag:!!C.needOptions.lastNameFlag,mobileFlag:!0,nationalityFlag:!!C.needOptions.nationalityFlag,passFlag:!!C.needOptions.passFlag,passportFlag:!!C.needOptions.passportFlag,phoneFlag:!!C.needOptions.phoneFlag,twPassFlag:!!C.needOptions.twPassFlag,twResidentFlag:!!C.needOptions.twResidentFlag,peopleTypeFlag:!!C.needOptions.peopleTypeFlag};J.setItem("specialBooker_fill",JSON.stringify([f]))}else D.showErr("服务器异常，请稍后再试")})}function o(a){var c=+C.clientDetail.maxQuantity;if("add"==a){if(!(C.quantities<c))return C.canAdd=!1,D.showErr("预定数超过最大起订量");C.quantities++,E.quantities=C.quantities,C.canSub=!0,C.quantities==c&&(C.canAdd=!1)}else if("subtract"==a){if(!(C.quantities>1))return C.canSub=!1,D.showErr("预定数不能小于1");C.quantities--,E.quantities=C.quantities,C.canSub=!0,C.canAdd=!0,1==C.quantities&&(C.canSub=!1)}if(!a&&E.oughtPay&&(C.oughtPay=E.oughtPay),E.visitDates){C.canOrder=!1,C.canSub=!0,1==C.quantities&&(C.canSub=!1);var d={quantities:C.quantities,visitDates:C.date,provinceId:E.provinceId||null,cityId:E.cityId||null,unExpInsurId:C.unExpInsurId,retreatInsurId:C.retreatInsurId,invoiceExpressGoodsId:C.invoiceExpressGoodsId||""};if(h.getUrlParam("combProductId")){var e=[],f=[];for(var g in E.goodsIds)e[g]=C.quantities*C.packageCount[g],f[g]=C.date;d.quantities=e,d.visitDates=f}E.goodsIds&&(d.goodsIds=E.goodsIds),b.countTicketPrice(d,C.saleChannel).then(function(a){if(1!=a.code)return void D.showErr(a.message||"计算价格接口异常");var b=a.data;C.totalPrice=b.oughtPay,C.promotionList=b.promotionList,C.hasProm=+b.promotionAmountToYuan>0,C.oughtPay=E.oughtPay=b.oughtPay,C.promotionAmountToYuan=b.promotionAmountToYuan,C.expressTips=b.expressTips,C.expressPriceToYuan=b.expressPriceToYuan,C.unExpInsurQuantity=b.unExpIsurQuantity||C.quantities,E.expGoodsId=[],h.isNotEmpty(b.expressGoodsMaps)?(E.expGoodsId[0]=b.expressGoodsMaps[0].goods.suppGoodsId,E.hasExpress=!0):E.hasExpress=!1,C.invoiceExpressGoodsId&&E.expGoodsId.push(C.invoiceExpressGoodsId),C.canOrder=!0,y()},function(a){D.showErr("计算价格接口异常")})}}function p(a){var c={quantities:C.quantities};if(C.unExpInsurId&&(c.unExpInsurId=C.unExpInsurId,c.unExpInsurQuantity=C.unExpInsurQuantity),C.retreatInsurId&&(c.retreatInsurId=C.retreatInsurId),E.goodsIds&&(c.goodsIds=E.goodsIds),E.visitDates&&(c.visitDates=E.visitDates),h.getUrlParam("combProductId")){var d=[],e=[];for(var f in E.goodsIds)d[f]=C.quantities*C.packageCount[f],e[f]=C.date;c.quantities=d,c.visitDates=e}b.checkTicketOrder(c,C.saleChannel).then(function(b){var c,d,e;if(1==b.code){if(E.travellerNum=d=b.data.travellers.length,!b.data.needTravellerFlag)return E.travellerNames=[],E.travellerMobiles=[],E.travellerFirstNames=[],E.travellerLastNames=[],E.travellerEmails=[],E.travellerGenders=[],E.travellerBirths=[],E.travellerIdTypes=[],E.travellerIdNos=[],void(a&&D.createOrder());C.travellers=b.data.travellers;var f=[];b.data.travellers.forEach(function(a){a.peopleTypeFlag=a.occupType,delete a.occupType,f.push(a)}),C.cardType=[],c=C.travellers[0],c.idFlag&&C.cardType.push("身份证"),c.passportFlag&&C.cardType.push("护照"),c.passFlag&&C.cardType.push("港澳通行证"),c.twPassFlag&&C.cardType.push("台湾通行证"),c.twResidentFlag&&C.cardType.push("台胞证"),c.hkResidentFlag&&C.cardType.push("回乡证"),!C.cardType.length&&(C.needCert=!1);for(var g=0;g<d;g++)C.cardSelect[g]&&-1!=C.cardType.indexOf(C.cardSelect[g])||(C.cardSelect[g]=C.cardType[0],E.travellerIdTypes[g]=G[C.cardType[0]],E.travellerIdNos[g]="");J.getItem("specialTraveller_fill")||(E.travellerNames[0]=E.contactName,E.travellerMobiles[0]=E.contactMobile,E.travellerFirstNames[0]=E.contactFirstName,E.travellerLastNames[0]=E.contactLastName,E.travellerEmails[0]=E.contactEmail,E.travellerGenders[0]=E.contactGender,E.travellerBirths[0]=E.contactBirth,C.cardType.indexOf(C.certName)>-1&&(E.travellerIdTypes[0]=E.contactIdType,E.travellerIdNos[0]=E.contactIdNo,C.cardSelect[0]=C.certName));var h=JSON.parse(J.getItem("special_traveller"));if(h){for(var d=h.length,i=0;i<d;i++)E.travellerNames[i]=h[i].receiverName,E.travellerMobiles[i]=h[i].mobileNumber,E.travellerFirstNames[i]=h[i].firstName,E.travellerLastNames[i]=h[i].lastName,E.travellerEmails[i]=h[i].email,C.cardSelect[i]=h[i].certType,E.travellerIdNos[i]=h[i].certNo,E.travellerGenders[i]=h[i].receiverGender,E.travellerBirths[i]=h[i].birthday;var j=[];h.forEach(function(a){a.receiverId&&j.push(a.receiverId)}),J.setItem("special_traveller_choose",JSON.stringify(j))}J.setItem("specialTraveller_fill",JSON.stringify(f)),E.travellerNames.length>=C.travellers.length&&a&&(E.travellerNames.length=C.travellers.length,E.travellerMobiles.length=C.travellers.length,E.travellerFirstNames.length=C.travellers.length,E.travellerLastNames.length=C.travellers.length,E.travellerEmails.length=C.travellers.length,E.travellerGenders.length=C.travellers.length,E.travellerBirths.length=C.travellers.length,E.travellerIdTypes.length=C.travellers.length,E.travellerIdNos.length=C.travellers.length,C.cardSelect.length=C.travellers.length,D.createOrder())}else E.travellerNum=0,D.showErr(b.errorMessage);s("checkRes",b),s("special_orderInit",!0),(e=E.personIndex)>=0&&(C.cardSelect[e]=E.IdTypesCn[e]),C.canOrder=!0},function(a){alert(a)})}function q(){var a=[{check:E.visitDates,err:"请选择游玩日期"},{check:C.readContract,err:"你需要同意"+C.inpTickOrder.xieyiName+"才能预订哦"}];if(E.quantities=C.quantities,E.travellerNames)for(var c=0,d=C.cardSelect.length;c<d;c+=1)E.travellerIdTypes[c]=G[C.cardSelect[c]];if(C.brandStoreId&&(E.brandTag=!0,E.brandStoreId=C.brandStoreId),E.unExpInsurId=C.unExpInsurId,E.retreatInsurId=C.retreatInsurId,E.unExpInsurQuantity=C.unExpInsurQuantity,b.validate(C,"errorMsg","showErrMsg",a)){var e=E.quantities,f=E.visitDates;E.address=E.addressName,E.seckillPk=C.seckillPk,E.saleChannel=C.saleChannel,delete E.addressPC,C.specialCert||(delete E.contactGender,delete E.contactBirth),x(),console.log(E),b.createOrder(E,C).then(function(a){1==a.code?(J.removeItem("datePickerData"),J.removeItem("ticket_skill_DATA"),J.removeItem("special_booker_choose"),J.removeItem("specialBooker_fill"),J.removeItem("special_booker"),J.removeItem("specialTraveller_fill"),J.removeItem("special_traveller"),J.removeItem("special_traveller_choose"),J.removeItem("H5specialTicket_invoiceApply"),b.postlosc(a.data.orderId,function(b){location.href="https://m.lvmama.com/lvwappay/vorder_success.htm?orderId="+a.data.orderId})):(E.quantities=e,E.visitDates=f)})}}function r(a){return g.getData(a)}function s(a,b){return g.setData(a,b),r(a)}function t(a){return i.trustAsHtml((a||"").replace(/\n/g,"<br>"))}function u(){function a(a){for(var b={title:"选择所在地区",isActive:!0,colCount:2,colOptions:[{widthPercent:50,align:"center",defaultCode:2e3},{widthPercent:50,align:"center",defaultCode:2e3}]},c=[],d=2e3,e=1,f=a.length;e<f;e+=1){var g={};g.key=a[e].key,g.code=d,g.name=a[e].value,g.column=1,g.pCode=null,c.push(g);for(var h=0,i=a[e].list.length;h<i;h+=1){var g={};g.key=a[e].list[h].key||0,g.name=a[e].list[h].value,g.column=2,g.pCode=d,c.push(g)}d++}return b.data=c,b}b.getCity().then(function(b){F=a(b.data.tree)},function(a){})}function v(){!J.getItem("H5specialTicket_invoiceApply")&&C.invoiceBasicInfoVo.contactName&&(C.invoiceBasicInfoVo.fullName=C.invoiceBasicInfoVo.contactName,C.invoiceBasicInfoVo.invoiceType=1,J.setItem("H5specialTicket_invoiceApply",JSON.stringify(C.invoiceBasicInfoVo)))}function w(){var a=J.getItem("H5specialTicket_invoiceApply")||"{}";JSON.parse(a).fullName&&C.invoiceBasicInfoVo.invoiceType&&(C.invoiceBasicInfoVo=a,C.invoiceBasicInfoVo.contactName=C.invoiceBasicInfoVo.fullName,C.invoiceExpressGoodsId=1==C.invoiceBasicInfoVo.invoiceType?C.invoiceBasicInfoVo.expressage.invoiceFeeId:"",J.removeItem("H5specialTicket_invoiceApply"))}function x(){C.invoiceBasicInfoVo.invoiceType&&(E.title=C.invoiceBasicInfoVo.title,E.content=C.invoiceBasicInfoVo.content,E.purchaseWay=C.invoiceBasicInfoVo.purchaseWay,E.taxNumber=C.invoiceBasicInfoVo.taxNumber,E.buyerAddress=C.invoiceBasicInfoVo.buyerAddress,E.buyerTelephone=C.invoiceBasicInfoVo.buyerTelephone,E.bankAccount=C.invoiceBasicInfoVo.bankAccount,E.accountBankAccount=C.invoiceBasicInfoVo.accountBankAccount,E.province=C.invoiceBasicInfoVo.province,E.city=C.invoiceBasicInfoVo.city,E.district=C.invoiceBasicInfoVo.district,E.street=C.invoiceBasicInfoVo.street,E.postalCode=C.invoiceBasicInfoVo.postalCode,E.fullName=C.invoiceBasicInfoVo.contactName,E.mobile=C.invoiceBasicInfoVo.mobile,E.invoiceType=C.invoiceBasicInfoVo.invoiceType,E.receiverEmail=C.invoiceBasicInfoVo.receiverEmail)}function y(){if(!h.getUrlParam("combProductId")&&E.visitDates!=J.getItem("special_visitDate")){var a={productId:h.getUrlParam("productId"),suppGoodsIds:h.getUrlParam("goodsIds"),vistorDate:E.visitDates};J.setItem("special_visitDate",E.visitDates),b.getInsurance(a).then(function(a){console.log(a),1==a.code?(C.retirementInsurance=A(z(a.data.retirementInsurance)),C.accidentInsurance=A(z(a.data.accidentInsurance)),C.reInsureSelected=!1,C.currentReInsure=C.retirementInsurance[C.retirementInsurance.length-1],C.acInsureSelected=!1,C.currentAcInsure=C.accidentInsurance[C.accidentInsurance.length-1],J.setItem("special_insures",JSON.stringify({accidentInsurance:C.accidentInsurance,retirementInsurance:C.retirementInsurance})),j()):D.showErr(a.message||"获取保险数据异常")},function(a){D.showErr("获取保险接口异常！")})}}function z(a){for(var b,c,d=0,e=a.length;d<e;d++)for(b=0;b<e;b++)a[d].sellPrice>a[b].sellPrice&&(c=a[b],a[b]=a[d],a[d]=c);return a}function A(a){for(var b=0;b<a.length;b++)a[b].index=b;return a}function B(){if(E.visitDates==J.getItem("special_visitDate")){if(JSON.parse(localStorage.getItem("special_insureSelected"))){var a=JSON.parse(J.getItem("special_insureSelected"));a&&(C.retirementInsurance=a.retirementInsurance,C.accidentInsurance=a.accidentInsurance,C.currentReInsure=a.currentReInsure,C.currentAcInsure=a.currentAcInsure,C.reInsureIndex=a.reInsureIndex,C.acInsureIndex=a.acInsureIndex,C.reInsureSelected=a.reInsureSelected,C.acInsureSelected=a.acInsureSelected,C.retreatInsurId=a.retreatInsurId,C.unExpInsurId=a.unExpInsurId);var b=parseInt(d.search().acInsureIndex),c=parseInt(d.search().reInsureIndex);b>=0&&C.acInsureSelected?(C.acInsureSelected=!0,C.acInsureIndex=b,C.currentAcInsure=C.accidentInsurance[b],C.unExpInsurId=C.accidentInsurance[b].suppGoodsId):(C.unExpInsurId=C.unExpInsurId||"",C.acInsureSelected=C.acInsureSelected||!1,C.acInsureIndex=C.acInsureIndex||""),c>=0&&C.reInsureSelected?(C.reInsureSelected=!0,C.reInsureIndex=c,C.currentReInsure=C.retirementInsurance[c],C.retreatInsurId=C.retirementInsurance[c].suppGoodsId):(C.retreatInsurId=C.retreatInsurId||"",C.reInsureSelected=C.reInsureSelected||!1,C.reInsureIndex=C.reInsureIndex||"")}}}var C,D,E=r("special_order")||{},F="",G={"身份证":"ID_CARD","护照":"HUZHAO","港澳通行证":"GANGAO","台湾通行证":"TAIBAO","台胞证":"TAIBAOZHENG","回乡证":"HUIXIANG"},H=/^\d{11}$/,I=h.getCookie("lvsessionid")||"",J=window.localStorage,K=J.getItem("datePickerData"),L=J.getItem("ticket_skill_DATA");J.removeItem("ticket_skill_DATA"),L&&(E=JSON.parse(L)),K&&(E.visitDates=JSON.parse(K).goDateInfo.curDateObj.dateFormat,E.visitDay=JSON.parse(K).goDateInfo.curDateObj.cnDay),E.referrer=E.referrer||document.referrer,E.contactIdType="",E.contactIdNo="",a.DATA=E,a.model=C={canOrder:!1,travellers:null,needCert:!0,quantities:E.quantities||1,totalPrice:0,showNotice:!1,date:E.visitDates,week:E.visitDay,canSub:!1,canAdd:!0,cardType:[],cardSelect:[],cardIndex:null,showFee:!1,readContract:!0,addressPC:E.addressPC||null,isLogin:!1,isNeedImgCode:!0,isNeedMsgAuthCode:!0,second:60,brandStoreId:d.search().brandStoreId||"",retirementInsurance:[],accidentInsurance:[],currentReInsure:"",currentAcInsure:"",reInsureIndex:"",acInsureIndex:"",reInsureSelected:!1,acInsureSelected:!1,insureNoticeShow:!1,retreatInsurId:"",unExpInsurId:"",currentShowInsure:{descHTML:""},ableCertTypes:[],specialCert:!1},a.fn=D={countTicketPrice:o,createOrder:q,checkTicketOrder:p,showSelectCerts:function(){C.selectCertShow=!C.selectCertShow},selectCert:function(a){C.certName=a,E.contactIdType=G[a],["HUZHAO","GANGAO","TAIBAO"].indexOf(E.contactIdType)>-1?C.specialCert=!0:C.specialCert=!1,C.selectCertShow=!C.selectCertShow},choseGender:function(a){E.contactGender=a},showBirth:function(){function b(){}function c(){var b=e.getSelectedValues(),c=b.values[0].substring(0,4),d=parseInt(b.values[1].substring(0,b.values[1].length-1))<10?"0"+parseInt(b.values[1].substring(0,b.values[1].length-1)):parseInt(b.values[1].substring(0,b.values[1].length-1)),f=parseInt(b.values[2].substring(0,b.values[2].length-1))<10?"0"+parseInt(b.values[2].substring(0,b.values[2].length-1)):parseInt(b.values[2].substring(0,b.values[2].length-1));E.contactBirth=c+"-"+d+"-"+f,a.$digest()}if(!C.spinFlag){C.spinFlag=!0;var d={title:"请选择出生日期",isActive:!0,extraParam:{name:"date",range:[1900,2020],align:["center","center","center"],width:[30,30,30],defaultValue:E.contactBirth?E.contactBirth.split("-"):[1987,1,1]}},e=new SpinWheel;e.setData(d),e.setCancelAction(b),e.setDoneAction(c),setTimeout(function(){C.spinFlag=!1,e.open()},300)}},choseTravellersGender:function(a,b){E.travellerGenders[b]=a},showTravellersBirth:function(b){function c(){}function d(){var c=f.getSelectedValues(),d=c.values[0].substring(0,4),e=parseInt(c.values[1].substring(0,c.values[1].length-1))<10?"0"+parseInt(c.values[1].substring(0,c.values[1].length-1)):parseInt(c.values[1].substring(0,c.values[1].length-1)),g=parseInt(c.values[2].substring(0,c.values[2].length-1))<10?"0"+parseInt(c.values[2].substring(0,c.values[2].length-1)):parseInt(c.values[2].substring(0,c.values[2].length-1));E.travellerBirths[b]=d+"-"+e+"-"+g,a.$digest()}if(!C.spinFlag){C.spinFlag=!0;var e={title:"请选择出生日期",isActive:!0,extraParam:{name:"date",range:[1900,2020],align:["center","center","center"],width:[30,30,30],defaultValue:E.travellerBirths[b]?E.travellerBirths[b].split("-"):[1987,1,1]}},f=new SpinWheel;f.setData(e),f.setCancelAction(c),f.setDoneAction(d),setTimeout(function(){C.spinFlag=!1,f.open()},300)}},goLogin:function(){window.location.href="//m.lvmama.com/login.htm?service="+encodeURIComponent(window.location.href)},showNotice:function(){C.showNotice=!0},closeNotice:function(){C.showNotice=!1},goTuan:function(){confirm("还没抢到手哦，确定要离开吗？")&&history.go(0-routeCounter)},selectDate:function(){E.unload=!1,d.path("datePicker")},showType:function(a){C.cardIndex=a,C.maskShow=!0},hideMask:function(){C.maskShow=!1,C.selectCertShow=!1},selectType:function(a){var b=a.target||a.srcElement;C.cardSelect[C.cardIndex]=b.innerHTML,E.travellerIdTypes[C.cardIndex]=G[b.innerHTML],C.maskShow=!1},goBooker:function(a,b){E.personType=a,E.personIndex=b,E.unload=!1,localStorage.setItem("ticket_skill_DATA",JSON.stringify(E)),window.location.href="CONTACT"===a?"//m.lvmama.com/static/coding/v2/userInfo/dist/#/select?playerEdit=specialBooker_edit&fillName=specialBooker_fill&editFillName=specialBooker_editFillName&type=select&selectedName=special_booker_choose&paramName=special_booker&cmType=ticket&personCount=1&backUrl="+encodeURIComponent(window.location.href):"//m.lvmama.com/static/coding/v2/userInfo/dist/#/select?playerEdit=specialTraveller_edit&fillName=specialTraveller_fill&editFillName=specialTraveller_editFillName&type=select&selectedName=special_traveller_choose&paramName=special_traveller&cmType=ticket&personCount="+C.travellers.length+"&backUrl="+encodeURIComponent(window.location.href)},goAddress:function(){E.unload=!1,d.path("addressChoose")},goInvoice:function(){v(),window.location.href="https://m.lvmama.com/webapp/invoice/#/applyInvoice?addExpressage=true&categoryId="+C.inpTickOrder.bizCategoryId+"&storageName=H5specialTicket&backUrl="+encodeURIComponent(window.location.href)},getCitySelect:function(a){var b=new SpinWheel,c=a.target||a.srcElement;b.setData(F),b.setCancelAction(function(){c.value=null}),b.setDoneAction(function(){var a=b.getSelectedValues();if(0==a.keys[1])return $("#triggerErr")[0].click(),!0;c.value=a.values.join(" "),E.addressPC=c.value,C.addressProvince=E.addressProvince=a.values[0],E.addressCity=a.values[1],E.provinceId=a.ids[0],E.cityId=a.ids[1],!!C.date&&o()}),b.open()},triggerErr:function(){return D.showErr("请选择省份和城市")},showErr:function(a){return C.errorMsg=a,C.showErrMsg=!0,c(function(){C.showErrMsg=!1},2e3),!1},showFee:function(){if(!E.visitDates)return D.showErr("请选择游玩日期");C.showFee=!C.showFee},readContract:function(){C.readContract=!C.readContract},goCoupon:function(){E.unload=!1,d.path("coupon")},runStatis:function(a){h.runStatis(a),setTimeout(function(){window.location.href=C.inpTickOrder.xieyiUrl},500)},refreshImgCode:function(){C.imgCodeUrl=C.imgCodeUrl+"&v="+Math.random()},getMsgCode:function(){if(C.date&&H.test(E.contactMobile)){var a={mobile:E.contactMobile,validateCode:E.validateCode,lvsessionid:I};b.getMsgCode(a).then(function(a){1==a.code?(k(),C.countDown=!0):2==a.code?(C.isNeedImgCode=!0,C.imgCodeUrl=C.imgCodeUrl+"&v="+Math.random(),D.showErr("请输入图形验证码")):D.showErr(a.message)},function(a){D.showErr("服务器异常，请稍后再试")})}else C.date?E.contactMobile?H.test(E.contactMobile)||D.showErr("请输入正确的手机号码"):D.showErr("请输入预订人的手机号码"):D.showErr("请选择游玩时间")},showInsureNotice:function(a){"retirement"==a?(C.insureNoticeShow=!0,C.currentShowInsure=C.currentReInsure,C.currentShowInsure.descHTML=i.trustAsHtml(C.currentShowInsure.desc.replace(/pt/g,"px"))):"accident"==a?(C.insureNoticeShow=!0,C.currentShowInsure=C.currentAcInsure,C.currentShowInsure.descHTML=i.trustAsHtml(C.currentShowInsure.desc.replace(/pt/g,"px"))):C.insureNoticeShow=!1},choseInsure:function(a){"accident"==a?(C.acInsureSelected=!C.acInsureSelected,C.acInsureSelected?(C.unExpInsurId=C.currentAcInsure.suppGoodsId,C.acInsureIndex=C.currentAcInsure.index):(C.unExpInsurId="",C.acInsureIndex="")):"retirement"==a&&(C.reInsureSelected=!C.reInsureSelected,C.reInsureSelected?(C.retreatInsurId=C.currentReInsure.suppGoodsId,C.reInsureIndex=C.currentReInsure.index):(C.retreatInsurId="",C.reInsureIndex="")),j(),o()},goChangeInsure:function(){C.acInsureSelected?d.search().acInsureIndex=C.acInsureIndex:d.search().acInsureIndex="",C.reInsureSelected?d.search().reInsureIndex=C.reInsureIndex:d.search().reInsureIndex="",d.path("insure")}},!!E.visitDates&&!!E.addressPC&&function(){var a={quantities:C.quantities,visitDates:C.date,provinceId:E.provinceId||null,cityId:E.cityId||null,unExpInsurId:C.unExpInsurId,retreatInsurId:C.retreatInsurId,invoiceExpressGoodsId:C.invoiceExpressGoodsId||""};E.goodsIds&&(a.goodsIds=E.goodsIds),b.countTicketPrice(a).then(function(a){var b=a.data;C.expressTips=b.expressTips,C.expressPriceToYuan=b.expressPriceToYuan,C.unExpInsurQuantity=b.unExpIsurQuantity||"",E.expGoodsId=[],h.isNotEmpty(b.expressGoodsMaps)?(E.expGoodsId[0]=b.expressGoodsMaps[0].goods.suppGoodsId,E.hasExpress=!0):E.hasExpress=!1,C.invoiceExpressGoodsId&&E.expGoodsId.push(C.invoiceExpressGoodsId)},function(a){})}(),a.$on("$routeChangeStart",function(a,b,c){E.quantities=C.quantities,C.oughtPay&&(E.oughtPay=C.oughtPay||0),E.unload=!1,s("special_order",E)}),B(),l(),w()}]),orderControllers.controller("errCtrl",["$rootScope",function(a){a.showErrMsg=!1}]),orderServices.factory("ticketOrderInputService",["cm","$location",function(a,b){function c(a){var b={}.toString;for(var c in a)if("[object Array]"==b.call(a[c]))for(var d=0,e=a[c].length;d<e;d+=1){try{var f=a[c][d];if(void 0!=f||null!=f)break}catch(g){delete a[c];break}delete a[c]}else void 0!==a[c]&&null!==a[c]||delete a[c]}var d=a.commonParams;return{inputTicketOrder:function(b){return angular.extend(b,d),b.combProductId?b.saleId=b.combProductId:b.saleId=b.goodsIds,a.get({loadingText:"加载中...",url:a.getUrls().inputTicketOrder,params:b})},getInputOptions:function(b){return a.get({loadingText:"加载中...",url:a.getUrls().getInputOptions,params:b})},countTicketPrice:function(b,c){return angular.extend(d,b),d.saleChannel=c,a.get({loadingText:"加载中...",url:a.getUrls().countTicketPrice,params:d})},checkTicketOrder:function(b,c){return a.get({loadingText:"加载中...",url:a.getUrls().checkTicketOrder,params:b})},createOrder:function(b,e){angular.extend(d,b),c(d),d.combProductId?d.saleId=d.combProductId:d.saleId=d.goodsIds,d.lvsessionid=a.getCookie("lvsessionid"),d.distributorCode=a.getCookie("cpsId")||"",delete d.referrer;var f={};if(a.getUrlParam("combProductId")){for(var g in d)d[g]&&(f[g]=d[g]);var h=[],i=[];for(var g in d.goodsIds)h[g]=e.quantities*e.packageCount[g],i[g]=e.date;f.quantities=h,f.visitDates=i,f.goodsIds=d.goodsIds,f.comQuantity=e.quantities}else for(var g in d)"combProductId"!=g&&d[g]&&(f[g]=d[g]);return a.get({loadingText:"加载中...",url:a.getUrls().createOrder,params:f})},postlosc:function(b,c){var d={},e=a.getCookie("oIC")||"",f=a.getCookie("oUC")||"",g=a.getCookie("orderFromChannelwap")||"";if(d.orderId=b,e||f||g){for(var h=e.length,i=0,j=[],k=[],l=[];i<h;)j[j.length]=e.substr(i,6),i+=6;for(j=j.filter(function(a,b,c){return c.indexOf(a)==b}),h=f.length,i=0;i<h;)k[k.length]=f.substr(i,6),i+=6;return k=k.filter(function(a,b,c){return c.indexOf(a)==b}),h=g.length,i=0,i<h&&(l[l.length]=g),d.loscIds=l.concat(j,k).join(","),a.get({loadingText:"加载中...",url:a.getUrls().postlosc,params:d}),c()}return c()},getCity:function(b){return a.get({loadingText:"加载中...",url:a.getUrls().getCity,params:b})},validate:function(b,c,d,e){return a.validate(b,c,d,e)},getUser:function(b){return a.get({loadingText:"加载中...",url:a.getUrls().getUser})},checkImgCode:function(){return a.get({loadingText:"加载中...",url:a.getUrls().checkImgCode,params:{actionName:actionName}})},isNeedMsgAuthCode:function(){return a.get({loadingText:"加载中...",url:a.getUrls().isNeedMsgAuthCode,params:{actionName:actionName}})},getMsgCode:function(b){return a.get({loadingText:"加载中...",url:a.getUrls().getMsgCode,params:b})},getInsurance:function(b){return a.get({loadingText:"加载中...",url:a.getUrls().getInsurance,params:b})}}}]),orderControllers.controller("testController",["$scope","testService",function(a,b){b.getTestWord().then(function(b){a.word=b.word})}]),orderServices.factory("testService",["cm",function(a){return{getTestWord:function(){return a.get({loadingText:"加载中...",url:a.getUrls().test,params:{}})}}}]);